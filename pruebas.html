<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pruebas - Registro 2026</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="stylesheet" href="styles.css">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/svg+xml" href="icon.svg">
    <link rel="apple-touch-icon" href="icon.svg">
    <meta name="theme-color" content="#fb7185">
    <style>
        .page-pruebas .nav-active {
            background: var(--primary-light);
            color: var(--primary-vibrant);
            box-shadow: var(--nm-shadow-in);
        }
    </style>
</head>

<body class="flex min-h-screen page-pruebas">
    <button class="sidebar-toggle no-print" onclick="toggleSidebar()">
        <i data-lucide="menu"></i>
    </button>
    <aside
        class="w-20 hover:w-64 bg-white border-r border-slate-100 transition-all duration-300 flex flex-col h-screen sticky top-0 z-40 overflow-hidden group">
        <div class="flex flex-col gap-3 p-4 mt-6">
            <a href="config.html"
                class="flex items-center gap-4 p-3 rounded-2xl text-slate-400 hover:bg-slate-50 transition-all">
                <i data-lucide="settings"></i>
                <span
                    class="opacity-0 group-hover:opacity-100 transition-opacity font-medium text-sm">Configuración</span>
            </a>
            <a href="index.html"
                class="flex items-center gap-4 p-3 rounded-2xl hover:bg-slate-50 text-slate-400 transition-all">
                <i data-lucide="layout-dashboard"></i>
                <span class="opacity-0 group-hover:opacity-100 transition-opacity font-medium text-sm">Inicio</span>
            </a>
            <a href="estudiantes.html"
                class="flex items-center gap-4 p-3 rounded-2xl hover:bg-slate-50 text-slate-400 transition-all">
                <i data-lucide="users"></i>
                <span
                    class="opacity-0 group-hover:opacity-100 transition-opacity font-medium text-sm">Estudiantes</span>
            </a>
            <a href="bitacora.html"
                class="flex items-center gap-4 p-3 rounded-2xl text-slate-400 hover:bg-slate-50 transition-all">
                <i data-lucide="book-open"></i>
                <span class="opacity-0 group-hover:opacity-100 transition-opacity font-medium text-sm">Bitácora</span>
            </a>
            <a href="calendario.html"
                class="flex items-center gap-4 p-3 rounded-2xl text-slate-400 hover:bg-slate-50 transition-all">
                <i data-lucide="calendar"></i>
                <span class="opacity-0 group-hover:opacity-100 transition-opacity font-medium text-sm">Calendario</span>
            </a>
        </div>
    </aside>

    <main class="flex-1 p-8">
        <header class="page-title mb-8 flex items-center justify-between border-b border-slate-100 pb-6 uppercase">
            <h1><i data-lucide="file-text" class="title-icon icon-vibrant"></i> Pruebas</h1>
            <div
                class="flex items-center gap-3 bg-white px-4 py-1.5 rounded-full border border-slate-100 shadow-sm text-xs font-bold text-slate-600">
                <span id="display-group">---</span> <span class="text-slate-200">|</span> <span id="display-period"
                    class="text-blue-500">P-I</span>
            </div>
        </header>

        <div class="flex justify-between items-center mb-10">
            <div class="flex gap-4">
                <button onclick="openTestModal()" class="btn-nm">
                    <i data-lucide="plus-circle" class="w-4 h-4 icon-vibrant"></i> Nueva Prueba
                </button>
                <button onclick="showGeneralReport()" class="btn-nm">
                    <i data-lucide="file-text" class="w-4 h-4 icon-vibrant"></i> Reporte del Componente
                </button>
            </div>
            <button onclick="location.href='index.html'" class="btn-nm">
                <i data-lucide="arrow-left" class="w-4 h-4 icon-vibrant"></i> Volver
            </button>
        </div>

        <div id="tests-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
    </main>

    <div id="modal-test" class="fixed inset-0 modal-blur z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-xl rounded-[2.5rem] shadow-2xl p-8">
            <h2 class="text-xl font-extrabold text-slate-800 mb-6 uppercase tracking-tight">Nueva Prueba</h2>
            <div class="space-y-5">
                <div>
                    <label class="text-[10px] font-black text-slate-400 uppercase mb-1 block">Nombre del Examen</label>
                    <input type="text" id="test-name" class="input-soft w-full" placeholder="Ej: I Prueba Parcial">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-[10px] font-black text-slate-400 uppercase mb-1 block">Fecha
                            Aplicación</label>
                        <input type="date" id="test-date" class="input-soft w-full">
                    </div>
                    <div>
                        <label class="text-[10px] font-black text-slate-400 uppercase mb-1 block">Puntos Totales</label>
                        <input type="number" id="test-pts" class="input-soft w-full">
                    </div>
                </div>
                <div>
                    <label class="text-[10px] font-black text-slate-400 uppercase mb-1 block">Valor Porcentual
                        (%)</label>
                    <input type="number" id="test-perc" class="input-soft w-full">
                    <p id="limit-info" class="text-[9px] mt-2 font-bold text-slate-400 italic"></p>
                </div>
            </div>
            <div class="mt-8 flex justify-between">
                <button onclick="closeTestModal()" class="text-slate-400 font-bold uppercase text-xs">Cancelar</button>
                <button onclick="saveTest()"
                    class="btn-minimal bg-blue-600 text-white px-8 py-3 border-none">Guardar</button>
            </div>
        </div>
    </div>

    <div id="modal-grading" class="fixed inset-0 modal-blur z-[60] hidden flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-7xl h-[90vh] rounded-[3rem] shadow-2xl flex flex-col overflow-hidden">
            <div class="p-6 border-b border-slate-50 flex justify-between items-center">
                <h2 id="grading-title" class="text-lg font-black text-slate-800 uppercase"></h2>
                <div class="flex gap-4">
                    <button onclick="downloadTestPDF()" class="p-2 text-slate-400 hover:text-blue-500"><i
                            data-lucide="download"></i></button>
                    <button onclick="closeGrading()"><i data-lucide="x"></i></button>
                </div>
            </div>
            <div class="flex-1 overflow-auto p-6">
                <table class="table-fixed-layout border-collapse">
                    <thead class="bg-slate-50 text-[9px] font-black text-slate-400 uppercase tracking-widest">
                        <tr>
                            <th class="p-4 text-left w-64">Estudiante</th>
                            <th class="p-4 w-32">Fecha Aplic.</th>
                            <th class="p-4 w-20">Adecuac.</th>
                            <th class="p-4 w-24">Pts Obt.</th>
                            <th class="p-4 w-24 text-blue-500">Nota (100)</th>
                            <th class="p-4 w-24 text-blue-700">% Ganado</th>
                            <th class="p-4 w-40">Firma Encargado</th>
                        </tr>
                    </thead>
                    <tbody id="grading-body" class="text-[11px]"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let state = JSON.parse(localStorage.getItem('academicApp_2026_data')) || {};
        if (!state.tests) state.tests = {};
        if (!state.test_evals) state.test_evals = {};

        const lvl = localStorage.getItem('temp_current_level') || '7';
        const sec = localStorage.getItem('temp_current_section') || '1';
        const period = state.settings?.currentPeriod || '1';

        // El tope del componente según el nivel
        const COMPONENT_LIMIT = (parseInt(lvl) >= 10) ? 50 : 40;
        let activeTestId = null;

        function init() {
            document.getElementById('display-group').innerText = `${lvl}-${sec}`;
            document.getElementById('display-period').innerText = `P-${period}`;
            document.getElementById('limit-info').innerText = `* El valor total de pruebas para este nivel es de ${COMPONENT_LIMIT}%`;
            renderTests();
            lucide.createIcons();
        }

        function openTestModal() {
            document.getElementById('modal-test').classList.remove('hidden');
        }

        function closeTestModal() { document.getElementById('modal-test').classList.add('hidden'); }

        function saveTest() {
            const name = document.getElementById('test-name').value;
            const date = document.getElementById('test-date').value;
            const pts = parseFloat(document.getElementById('test-pts').value);
            const perc = parseFloat(document.getElementById('test-perc').value);

            // Validar que no se pase del tope
            const currentTotal = Object.values(state.tests)
                .filter(t => t.level === lvl && t.section === sec && t.period === period)
                .reduce((acc, t) => acc + t.percent, 0);

            if (currentTotal + perc > COMPONENT_LIMIT) {
                return alert(`Error: La suma de pruebas (${currentTotal + perc}%) excede el ${COMPONENT_LIMIT}% permitido.`);
            }

            const id = Date.now().toString();
            state.tests[id] = { id, name, date, points: pts, percent: perc, level: lvl, section: sec, period };
            save(); renderTests(); closeTestModal();
        }

        function renderTests() {
            const container = document.getElementById('tests-container');
            const acts = Object.values(state.tests).filter(t => t.level === lvl && t.section === sec && t.period === period);

            container.innerHTML = acts.map(t => `
                <div class="card-premium group">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="font-extrabold text-slate-800 text-sm uppercase">${t.name}</h3>
                            <p class="text-[10px] font-bold text-blue-500">${t.percent}% - ${t.points} pts</p>
                        </div>
                        <button onclick="deleteTest('${t.id}')" class="opacity-0 group-hover:opacity-100 text-red-300 hover:text-red-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </div>
                    <button onclick="startGrading('${t.id}')"
                        class="w-full py-3 bg-rose-50 text-rose-600 rounded-2xl text-[10px] font-black uppercase tracking-widest hover:bg-rose-500 hover:text-white transition-all">Calificar</button>
                </div>
            `).join('');
            lucide.createIcons();
        }

        function startGrading(id) {
            activeTestId = id;
            document.getElementById('grading-title').innerText = state.tests[id].name;
            renderGradingList();
            document.getElementById('modal-grading').classList.remove('hidden');
        }

        function renderGradingList() {
            const t = state.tests[activeTestId];
            const students = (state.students[lvl] || []).filter(s => s.section === sec).sort((a, b) => a.name.localeCompare(b.name));
            const tbody = document.getElementById('grading-body');

            tbody.innerHTML = students.map(s => {
                const ev = state.test_evals[activeTestId]?.[s.id] || { pts: 0, date: t.date, sig: false, sigPts: t.points, sigPerc: t.percent, signed: "" };

                const maxPts = ev.sig ? ev.sigPts : t.points;
                const maxPerc = ev.sig ? ev.sigPerc : t.percent;
                const nota = maxPts > 0 ? (ev.pts * 100 / maxPts).toFixed(2) : 0;
                const porcGanado = (nota * maxPerc / 100).toFixed(2);

                return `
                <tr class="border-t border-slate-50">
                    <td class="p-4 font-bold text-slate-700">${s.name}</td>
                    <td class="p-2"><input type="date" value="${ev.date}" onchange="updateEval('${s.id}', 'date', this.value)" class="input-soft text-[10px] w-full"></td>
                    <td class="p-2 text-center">
                        <button onclick="toggleSig('${s.id}')" class="p-2 rounded-lg ${ev.sig ? 'bg-amber-100 text-amber-600' : 'bg-slate-50 text-slate-300'}"><i data-lucide="accessibility" class="w-4 h-4"></i></button>
                    </td>
                    <td class="p-2">
                        <div class="flex flex-col gap-1">
                            <input type="number" value="${ev.pts}" onchange="updateEval('${s.id}', 'pts', this.value)" class="input-soft text-center font-bold w-full" placeholder="Obt">
                            ${ev.sig ? `<input type="number" value="${ev.sigPts}" onchange="updateEval('${s.id}', 'sigPts', this.value)" class="input-soft text-[9px] text-amber-600 border-amber-100 text-center w-full" title="Puntos Adecuación">` : ''}
                        </div>
                    </td>
                    <td class="p-2 text-center font-black text-blue-500">${nota}</td>
                    <td class="p-2 text-center font-black text-blue-700">
                        ${porcGanado}%
                        ${ev.sig ? `<input type="number" value="${ev.sigPerc}" onchange="updateEval('${s.id}', 'sigPerc', this.value)" class="input-soft text-[9px] text-amber-600 border-amber-100 text-center w-full mt-1" title="% Adecuación">` : ''}
                    </td>
                    
<td class="p-2">
    <div class="flex items-center justify-center gap-2">
        <button onclick="toggleReturned('${s.id}')" 
            class="p-2 rounded-lg transition-all ${ev.isReturned ? 'bg-green-100 text-green-600' : 'bg-slate-100 text-slate-300'}">
            <i data-lucide="check-square" class="w-4 h-4"></i>
        </button>
        <input type="date" 
            value="${ev.signed}" 
            onchange="updateEval('${s.id}', 'signed', this.value)" 
            class="input-soft text-[10px] w-full ${!ev.isReturned ? 'signed-gray pointer-events-none' : ''}"
            ${!ev.isReturned ? 'disabled' : ''}>
    </div>
</td>
                </tr>`;
            }).join('');
            lucide.createIcons();

        }

        function updateEval(sId, field, val) {
            if (!state.test_evals[activeTestId]) state.test_evals[activeTestId] = {};
            if (!state.test_evals[activeTestId][sId]) {
                state.test_evals[activeTestId][sId] = {
                    pts: 0,
                    date: state.tests[activeTestId].date,
                    sig: false,
                    sigPts: state.tests[activeTestId].points,
                    sigPerc: state.tests[activeTestId].percent,
                    signed: "",
                    isReturned: false // Nueva propiedad para el check de firma
                };
            }

            let value = (field === 'pts' || field === 'sigPts' || field === 'sigPerc') ? parseFloat(val) : val;

            // Validación de tope de puntos
            if (field === 'pts') {
                const currentMax = state.test_evals[activeTestId][sId].sig ? state.test_evals[activeTestId][sId].sigPts : state.tests[activeTestId].points;
                if (value > currentMax) {
                    alert(`¡Error! Los puntos obtenidos (${value}) no pueden superar el total de la prueba (${currentMax}).`);
                    value = currentMax;
                }
            }

            state.test_evals[activeTestId][sId][field] = value;
            save();
            renderGradingList();
        }

        function toggleSig(sId) {
            const current = state.test_evals[activeTestId]?.[sId]?.sig || false;
            updateEval(sId, 'sig', !current);
        }

        function save() { localStorage.setItem('academicApp_2026_data', JSON.stringify(state)); }
        function closeGrading() { document.getElementById('modal-grading').classList.add('hidden'); }
        function deleteTest(id) { if (confirm("¿Eliminar prueba?")) { delete state.tests[id]; save(); renderTests(); } }
        function toggleReturned(sId) {
            const currentStatus = state.test_evals[activeTestId]?.[sId]?.isReturned || false;
            updateEval(sId, 'isReturned', !currentStatus);

            // Si desactivamos el check, limpiamos la fecha
            if (currentStatus) {
                updateEval(sId, 'signed', "");
            }
        }
        function showGeneralReport() {
            const table = document.getElementById('general-report-table');
            const students = (state.students[lvl] || []).filter(s => s.section === sec).sort((a, b) => a.name.localeCompare(b.name));
            const tests = Object.values(state.tests).filter(t => t.level === lvl && t.section === sec && t.period === period);

            // Actualizar info del encabezado del modal
            document.getElementById('general-report-period').innerText = `Periodo ${period === '1' ? 'I' : period === '2' ? 'II' : period} | Componente: ${COMPONENT_LIMIT}%`;

            let html = `
    <thead class="bg-slate-50 text-[9px] font-black text-slate-400 uppercase tracking-widest">
        <tr>
            <th class="p-4 sticky left-0 bg-slate-50 text-left">Estudiante</th>
            ${tests.map(t => `<th class="p-4 text-center border-l border-slate-100">${t.name}<br>(${t.percent}%)</th>`).join('')}
            <th class="p-4 text-center bg-rose-200 text-rose-800 border-l border-rose-300 font-black uppercase tracking-tighter">Total del Componente (${COMPONENT_LIMIT}%)</th>
        </tr>
    </thead>
    <tbody class="text-[11px]">`;

            students.forEach(s => {
                let totalSumPercent = 0;
                let celdas = "";

                tests.forEach(t => {
                    const ev = state.test_evals[t.id]?.[s.id] || { pts: 0, sig: false, sigPts: t.points, sigPerc: t.percent };
                    const maxPts = ev.sig ? ev.sigPts : t.points;
                    const maxPerc = ev.sig ? ev.sigPerc : t.percent;
                    const nota = maxPts > 0 ? (ev.pts * 100 / maxPts) : 0;
                    const porcGanado = parseFloat((nota * maxPerc / 100).toFixed(2));

                    totalSumPercent += porcGanado;
                    celdas += `<td class="p-4 text-center border-l border-slate-50 font-bold text-slate-600">${porcGanado}%</td>`;
                });

                html += `
        <tr class="border-t border-slate-50 hover:bg-slate-50/50">
            <td class="p-4 font-bold text-slate-700 sticky left-0 bg-white">${s.name}</td>
            ${celdas}
            <td class="p-4 text-center font-black text-rose-600 bg-rose-50/30 border-l border-rose-100">${totalSumPercent.toFixed(2)}%</td>
        </tr>`;
            });

            table.innerHTML = html + "</tbody>";
            document.getElementById('modal-general-report').classList.remove('hidden');
            lucide.createIcons();
        }

        // PDF INDIVIDUAL DE PRUEBA
        function downloadTestPDF() {
            const t = state.tests[activeTestId];
            const students = (state.students[lvl] || []).filter(s => s.section === sec).sort((a, b) => a.name.localeCompare(b.name));
            const printWindow = window.open('', '_blank');

            let html = `
    <html>
    <head>
        <title>Reporte Prueba - ${t.name}</title>
        <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;800&display=swap" rel="stylesheet">
        <style>
            body { font-family: 'Outfit', sans-serif; padding: 40px; color: #334155; font-size: 10px; }
            .professional-header { display: flex; justify-content: space-between; border-bottom: 2px solid #f1f5f9; padding-bottom: 20px; margin-bottom: 30px; text-transform: uppercase; }
            .prof-data p { margin: 2px 0; font-size: 9px; color: #64748b; }
            .prof-data b { color: #334155; }
            
            h2 { font-size: 14px; color: #1e293b; margin-bottom: 15px; text-transform: uppercase; letter-spacing: -0.5px; }
            table { width: 100%; border-collapse: collapse; margin-top: 20px; }
            th, td { border: 1px solid #cbd5e1; padding: 8px; text-align: center; }
            th { background: #f8fafc; font-size: 8px; text-transform: uppercase; font-weight: 800; }
            .sig { color: #d97706; font-weight: 800; font-size: 7px; text-transform: uppercase; }
            .name-cell { text-align: left !important; font-weight: 700; background: #ffffff; padding-left: 10px !important; }
        </style>
    </head>
    <body>
        <div class="professional-header">
            <div>
                <h1 style="margin:0; font-size:24px; color:#1e293b; font-weight:900; text-transform:uppercase;">${t.name}</h1>
                <p style="margin:5px 0 0 0; color:#e11d48; font-weight:900; text-transform:uppercase; font-size:12px;">NIVEL: ${lvl} | SECCIÓN: ${sec} | PERIODO: ${period === '1' ? 'I' : period === '2' ? 'II' : period}</p>
            </div>
            <div class="prof-data">
                <p>INSTITUCIÓN: <b>${state.admin.institution || 'MEP'}</b></p>
                <p>MATERIA: <b>${state.admin.subject || 'CÁLCULO'}</b></p>
                <p>DOCENTE: <b>${state.admin.name || '---'}</b></p>
                <p>INSTRUMENTO DE EVALUACIÓN: <b>PRUEBAS</b></p>
            </div>
        </div>

        <table>
            <thead>
                <tr>
                    <th style="width:250px">Estudiante</th>
                    <th>Fecha</th>
                    <th>Puntos Obt. / Tot.</th>
                    <th>Nota (100)</th>
                    <th style="background:#f8fafc; color:#1e293b">Ganado (${t.percent}%)</th>
                    <th>Firma / Estado</th>
                </tr>
            </thead>
            <tbody>
                ${students.map(s => {
                const ev = state.test_evals[t.id]?.[s.id] || { pts: 0, date: t.date, sig: false, sigPts: t.points, sigPerc: t.percent, signed: "" };
                const maxPts = ev.sig ? ev.sigPts : t.points;
                const maxPerc = ev.sig ? ev.sigPerc : t.percent;
                const nota = (ev.pts * 100 / maxPts).toFixed(2);
                const pG = (nota * maxPerc / 100).toFixed(2);
                return `<tr>
                            <td class="name-cell">${s.name} ${ev.sig ? '<br><span class="sig">[Adecuación Sign.]</span>' : ''}</td>
                            <td>${ev.date.split('-').reverse().join('/')}</td>
                            <td><b>${ev.pts}</b> / ${maxPts}</td>
                            <td><b>${nota}</b></td>
                            <td style="background:#f8fafc; font-weight:900; color:#334155;">${pG}%</td>
                            <td style="font-size:8px;">${ev.isReturned ? 'SÍ (' + (ev.signed.split('-').reverse().slice(0, 2).join('/')) + ')' : '<span style="color:#94a3b8; font-style:italic">Pendiente</span>'}</td>
                        </tr>`;
            }).join('')}
            </tbody>
        </table>
    </body>
    </html>`;

            printWindow.document.write(html);
            printWindow.document.close();
            printWindow.onload = () => { printWindow.print(); printWindow.close(); };
        }
        function downloadGeneralPDF() {
            const tests = Object.values(state.tests).filter(t => t.level === lvl && t.section === sec && t.period === period);
            const students = (state.students[lvl] || []).filter(s => s.section === sec).sort((a, b) => a.name.localeCompare(b.name));

            if (tests.length === 0) return alert("No hay pruebas registradas para este periodo.");

            const printWindow = window.open('', '_blank');

            let html = `
    <html>
    <head>
        <title>Consolidado Pruebas - ${lvl}-${sec}</title>
        <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;800&display=swap" rel="stylesheet">
        <style>
            body { font-family: 'Outfit', sans-serif; padding: 40px; color: #334155; font-size: 10px; }
            .professional-header { display: flex; justify-content: space-between; border-bottom: 2px solid #f1f5f9; padding-bottom: 20px; margin-bottom: 30px; text-transform: uppercase; }
            .prof-data p { margin: 2px 0; font-size: 9px; color: #64748b; }
            .prof-data b { color: #334155; }
            
            h1 { font-size: 18px; margin: 0; color: #1e293b; }
            table { width: 100%; border-collapse: collapse; margin-top: 20px; table-layout: fixed; }
            th, td { border: 1px solid #cbd5e1; padding: 8px; text-align: center; word-wrap: break-word; }
            th { background: #f8fafc; font-size: 8px; font-weight: 800; text-transform: uppercase; }
            
            .name-cell { text-align: left !important; font-weight: 700; width: 25%; }
            .final-total { background: #1e293b; color: white; font-weight: 800; }
            .footer { margin-top: 50px; display: flex; justify-content: space-around; font-size: 9px; }
        </style>
    </head>
    <body>
        <div class="professional-header">
            <div>
                <h1 style="margin:0; font-size:24px; color:#1e293b; font-weight:900; text-transform:uppercase;">Consolidado de Pruebas</h1>
                <p style="margin:5px 0 0 0; color:#e11d48; font-weight:900; text-transform:uppercase; font-size:12px;">NIVEL: ${lvl} | SECCIÓN: ${sec} | PERIODO: ${period === '1' ? 'I' : period === '2' ? 'II' : period}</p>
            </div>
            <div class="prof-data">
                <p>INSTITUCIÓN: <b>${state.admin.institution || 'MEP'}</b></p>
                <p>MATERIA: <b>${state.admin.subject || 'CÁLCULO'}</b></p>
                <p>DOCENTE: <b>${state.admin.name || '---'}</b></p>
                <p>INSTRUMENTO DE EVALUACIÓN: <b>PRUEBAS</b></p>
            </div>
        </div>

        <table>
            <thead>
                <tr>
                    <th style="width:250px">Estudiante</th>
                    ${tests.map(t => `<th>${t.name}<br>(${t.percent}%)</th>`).join('')}
                    <th style="background:#f8fafc; color:#1e293b">Total Ganado (${COMPONENT_LIMIT}%)</th>
                </tr>
            </thead>
            <tbody>
                ${students.map(s => {
                let totalSum = 0;
                const celdas = tests.map(t => {
                    const ev = state.test_evals[t.id]?.[s.id] || { pts: 0, sig: false, sigPts: t.points, sigPerc: t.percent };
                    const maxPts = ev.sig ? ev.sigPts : t.points;
                    const maxPerc = ev.sig ? ev.sigPerc : t.percent;
                    const nota = (ev.pts * 100 / maxPts) || 0;
                    const porcGanado = parseFloat((nota * maxPerc / 100).toFixed(2));
                    totalSum += porcGanado;
                    return `<td>${porcGanado}%</td>`;
                }).join('');

                return `
                        <tr>
                            <td class="name-cell" style="font-size:9px">${s.name}</td>
                            ${celdas}
                            <td style="background:#f8fafc; font-weight:900; color:#334155;">${totalSum.toFixed(2)}%</td>
                        </tr>`;
            }).join('')}
            </tbody>
        </table>

        <div class="footer">
            <div style="border-top:1px solid #334155; width:200px; padding-top:5px; text-align:center;">Firma del Docente</div>
        </div>
    </body>
    </html>`;

            printWindow.document.write(html);
            printWindow.document.close();
            printWindow.onload = () => {
                printWindow.print();
                printWindow.close();
            };
        }
        function closeGeneralReport() { document.getElementById('modal-general-report').classList.add('hidden'); }
        function toggleSidebar() {
            document.body.classList.toggle('sidebar-expanded');
        }
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
<div id="modal-general-report" class="fixed inset-0 modal-blur z-[70] hidden flex items-center justify-center p-4">
    <div class="bg-white w-full max-w-6xl max-h-[90vh] rounded-[3rem] shadow-2xl flex flex-col overflow-hidden">
        <div class="p-8 border-b border-slate-50 flex justify-between items-center bg-slate-50/30">
            <div>
                <h2 class="text-xl font-extrabold text-slate-800 uppercase tracking-tighter">
                    <i data-lucide="file-text" class="w-6 h-6 icon-vibrant inline-block mr-2 mb-1"></i> Consolidado de
                    Pruebas
                </h2>
                <p id="general-report-period"
                    class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mt-1">Periodo ---</p>
            </div>
            <div class="flex gap-4">
                <button onclick="downloadGeneralPDF()" class="btn-nm">
                    <i data-lucide="download" class="w-4 h-4 icon-vibrant"></i> Descargar PDF
                </button>
                <button onclick="closeGeneralReport()" class="p-2 hover:bg-slate-100 rounded-full transition-colors"><i
                        data-lucide="x"></i></button>
            </div>
        </div>
        <div class="flex-1 overflow-auto p-8">
            <table class="w-full text-left border-collapse" id="general-report-table">
            </table>
        </div>
    </div>
</div>

</html>