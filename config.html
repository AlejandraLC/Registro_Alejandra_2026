<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configuración - Registro 2026</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="stylesheet" href="styles.css">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="icon-192.png">
    <link rel="apple-touch-icon" href="icon-512.png">
    <meta name="theme-color" content="#740bf5">
    <style>
        .page-configuracion .nav-active {
            background: var(--primary-light);
            color: var(--primary-vibrant);
            box-shadow: var(--nm-shadow-in);
        }

        .input-soft-compact {
            background: #f1f5f9 !important;
            border: none !important;
            border-radius: 1rem !important;
            padding: 0.6rem 1rem !important;
            box-shadow: var(--nm-shadow-in) !important;
            outline: none !important;
            width: 100%;
            text-align: center;
            font-weight: 800;
            font-size: 0.9rem;
            color: var(--primary-vibrant);
        }

        /* Reducir padding de las tarjetas de porcentajes para que quepan mejor */
        .card-cycle {
            padding: 1.25rem !important;
            background: #f8fafc;
            border-radius: 2rem;
            border: 1px solid #f1f5f9;
            box-shadow: var(--nm-shadow-out);
        }
    </style>
</head>

<body class="flex min-h-screen page-configuracion">
    <button class="sidebar-toggle no-print" onclick="toggleSidebar()">
        <i data-lucide="menu"></i>
    </button>
    <aside
        class="w-20 hover:w-64 bg-white border-r border-slate-100 transition-all duration-300 flex flex-col h-screen sticky top-0 z-40 overflow-hidden group">
        <div class="flex flex-col gap-3 p-4 mt-6">
            <a href="config.html" class="flex items-center gap-4 p-3 rounded-2xl nav-active transition-all">
                <i data-lucide="settings"></i>
                <span
                    class="opacity-0 group-hover:opacity-100 transition-opacity font-medium text-sm">Configuración</span>
            </a>
            <a href="index.html"
                class="flex items-center gap-4 p-3 rounded-2xl hover:bg-slate-50 text-slate-400 transition-all">
                <i data-lucide="layout-dashboard"></i>
                <span class="opacity-0 group-hover:opacity-100 transition-opacity font-medium text-sm">Inicio</span>
            </a>
            <a href="estudiantes.html"
                class="flex items-center gap-4 p-3 rounded-2xl hover:bg-slate-50 text-slate-400 transition-all">
                <i data-lucide="users"></i>
                <span
                    class="opacity-0 group-hover:opacity-100 transition-opacity font-medium text-sm">Estudiantes</span>
            </a>
            <a href="comunicados.html"
                class="flex items-center gap-4 p-3 rounded-2xl text-slate-400 hover:bg-slate-50 transition-all">
                <i data-lucide="message-square"></i>
                <span
                    class="opacity-0 group-hover:opacity-100 transition-opacity font-medium text-sm">Comunicados</span>
            </a>
            <a href="bitacora.html"
                class="flex items-center gap-4 p-3 rounded-2xl text-slate-400 hover:bg-slate-50 transition-all">
                <i data-lucide="book-open"></i>
                <span class="opacity-0 group-hover:opacity-100 transition-opacity font-medium text-sm">Bitácora</span>
            </a>
            <a href="calendario.html"
                class="flex items-center gap-4 p-3 rounded-2xl text-slate-400 hover:bg-slate-50 transition-all">
                <i data-lucide="calendar"></i>
                <span class="opacity-0 group-hover:opacity-100 transition-opacity font-medium text-sm">Calendario</span>
            </a>
        </div>
    </aside>

    <main class="flex-1 p-10 max-w-4xl mx-auto">
        <header class="mb-10">
            <h1><i data-lucide="settings" class="title-icon"></i> Ajustes del Registro</h1>
            <p class="info-profesional">Configuración de
                información</p>
        </header>

        <div class="space-y-6">
            <section class="card-premium">
                <h2 class="card-title">
                    <div class="icon-vibrant">
                        <i data-lucide="user"></i>
                    </div>
                    Información técnica
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="flex flex-col">
                        <label class="card-text ml-2">Nombre del Docente</label>
                        <input type="text" id="conf-name" class="input-soft mt-1" placeholder="Nombre completo">
                    </div>
                    <div class="flex flex-col">
                        <label class="card-text ml-2">Institución</label>
                        <input type="text" id="conf-inst" class="input-soft mt-1"
                            placeholder="Nombre del Centro Educativo">
                    </div>
                    <div class="flex flex-col">
                        <label class="card-text ml-2">Materia</label>
                        <input type="text" id="conf-subject" class="input-soft mt-1" placeholder="Asignatura">
                    </div>
                    <div class="flex flex-col">
                        <label class="card-text ml-2">Curso Lectivo</label>
                        <input type="text" id="conf-year" class="input-soft mt-1" placeholder="Ej: 2026">
                    </div>
                    <div class="flex flex-col">
                        <label class="card-text ml-2">Supervisión Educativa Circuito</label>
                        <input type="text" id="conf-circuit" class="input-soft mt-1" placeholder="Ej: 01">
                    </div>
                    <div class="flex flex-col">
                        <label class="card-text ml-2">Dirección Regional de Educación</label>
                        <input type="text" id="conf-dre" class="input-soft mt-1" placeholder="Ej: Puriscal">
                    </div>
                </div>
            </section>

            <section class="card-premium">
                <h2 class="card-title">
                    <div class="icon-vibrant">
                        <i data-lucide="layers"></i>
                    </div>
                    Estructura de Grupos
                </h2>
                <div class="flex flex-col md:flex-row gap-8">
                    <div class="w-full md:w-1/3 space-y-4">
                        <select id="new-level" class="input-soft">
                            <option value="7">7° Año</option>
                            <option value="8">8° Año</option>
                            <option value="9">9° Año</option>
                            <option value="10">10° Año</option>
                            <option value="11">11° Año</option>
                        </select>
                        <input type="number" id="new-section" class="input-soft" placeholder="Sección (ej: 1)">
                        <button onclick="addGroup()" class="btn-nm w-full">Agregar</button>
                    </div>
                    <div id="groups-list"
                        class="flex-1 flex flex-wrap gap-3 p-6 bg-slate-50/50 rounded-[2rem] border border-slate-100 min-h-[120px] shadow-sm items-start content-start">
                    </div>
                </div>
            </section>

            <section class="card-premium">
                <h2 class="card-title">
                    <div class="icon-vibrant">
                        <i data-lucide="percent"></i>
                    </div>
                    Porcentajes por Ciclo
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- III Ciclo -->
                    <div class="card-cycle space-y-2">
                        <h3 class="text-xs font-black text-slate-400 uppercase tracking-widest flex items-center gap-2">
                            <i data-lucide="graduation-cap" class="icon-vibrant"></i> III Ciclo (7°, 8°, 9°)
                        </h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="flex flex-col">
                                <label class="text-[10px] font-bold text-slate-500 uppercase ml-2">Cotidiano (%)</label>
                                <input type="number" id="pct-iii-coti" class="input-soft-compact mt-1" placeholder="45">
                            </div>
                            <div class="flex flex-col">
                                <label class="text-[10px] font-bold text-slate-500 uppercase ml-2">Pruebas (%)</label>
                                <input type="number" id="pct-iii-test" class="input-soft-compact mt-1" placeholder="40">
                            </div>
                            <div class="flex flex-col">
                                <label class="text-[10px] font-bold text-slate-500 uppercase ml-2">Tareas (%)</label>
                                <input type="number" id="pct-iii-task" class="input-soft-compact mt-1" placeholder="10">
                            </div>
                            <div class="flex flex-col">
                                <label class="text-[10px] font-bold text-slate-500 uppercase ml-2">Asistencia
                                    (%)</label>
                                <input type="number" id="pct-iii-att" class="input-soft-compact mt-1" placeholder="5">
                            </div>
                        </div>
                    </div>

                    <!-- Diversificado -->
                    <div class="card-cycle space-y-2">
                        <h3 class="text-xs font-black text-slate-400 uppercase tracking-widest flex items-center gap-2">
                            <i data-lucide="award" class="icon-vibrant"></i> Diversificado (10°, 11°)
                        </h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="flex flex-col">
                                <label class="text-[10px] font-bold text-slate-500 uppercase ml-2">Cotidiano (%)</label>
                                <input type="number" id="pct-div-coti" class="input-soft-compact mt-1" placeholder="35">
                            </div>
                            <div class="flex flex-col">
                                <label class="text-[10px] font-bold text-slate-500 uppercase ml-2">Pruebas (%)</label>
                                <input type="number" id="pct-div-test" class="input-soft-compact mt-1" placeholder="50">
                            </div>
                            <div class="flex flex-col">
                                <label class="text-[10px] font-bold text-slate-500 uppercase ml-2">Tareas (%)</label>
                                <input type="number" id="pct-div-task" class="input-soft-compact mt-1" placeholder="10">
                            </div>
                            <div class="flex flex-col">
                                <label class="text-[10px] font-bold text-slate-500 uppercase ml-2">Asistencia
                                    (%)</label>
                                <input type="number" id="pct-div-att" class="input-soft-compact mt-1" placeholder="5">
                            </div>
                        </div>
                    </div>
                </div>
                <p class="text-[9px] font-medium text-slate-400 mt-4 italic">
                    <i data-lucide="info" class="w-3 h-3 inline"></i> Nota: La suma de cada ciclo debe ser normalmente
                    100%. Estas configuraciones se aplicarán a todos los cálculos del registro.
                </p>
            </section>

            <section class="card-config border-amber-50 bg-amber-50/5">
                <h2 class="card-title">
                    <div class="icon-vibrant">
                        <i data-lucide="database"></i>
                    </div>
                    Seguridad de Datos
                </h2>
                <div class="flex gap-4">
                    <button onclick="exportData()" class="btn-nm">
                        <i data-lucide="download" class="w-4 h-4 icon-vibrant"></i> Respaldar Todo
                    </button>
                    <label for="restore-file" class="btn-nm cursor-pointer">
                        <i data-lucide="upload" class="w-4 h-4 icon-vibrant"></i> Restaurar
                        <input type="file" id="restore-file" class="hidden" accept=".json" onchange="importData(event)">
                    </label>
                </div>
            </section>

            <div class="pt-4 flex justify-end">
                <button onclick="saveConfig()" class="btn-nm px-12 py-4">
                    Guardar y Volver
                </button>
            </div>
        </div>
    </main>

    <script>
        let state = JSON.parse(localStorage.getItem('academicApp_2026_data')) || { admin: {}, groups: [], students: {}, settings: {} };
        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const imported = JSON.parse(e.target.result);

                    // Verificamos que sea un respaldo válido del Registro
                    if (imported.admin && imported.groups) {
                        if (confirm("¿Confirmar restauración? Se reemplazará TODA la información actual por la de este respaldo.")) {
                            state = imported;
                            localStorage.setItem('academicApp_2026_data', JSON.stringify(state));
                            init(); // Recarga los campos con los nuevos datos
                            alert("¡Información restaurada con éxito! Ya puedes volver al Inicio.");
                        }
                    } else {
                        alert("El archivo no parece ser un respaldo válido de esta aplicación.");
                    }
                } catch (err) {
                    alert("Hubo un error al leer el archivo. Asegúrate de que sea el .json que descargaste.");
                }
            };
            reader.readAsText(file);
        }
        function init() {
            // Solo llena el campo si REALMENTE hay información guardada, 
            // de lo contrario lo deja vacío para que se vea el placeholder.
            document.getElementById('conf-name').value = state.admin.name || '';
            document.getElementById('conf-inst').value = state.admin.institution || '';
            document.getElementById('conf-subject').value = state.admin.subject || '';
            document.getElementById('conf-year').value = state.admin.year || '';
            document.getElementById('conf-circuit').value = state.admin.circuit || '';
            document.getElementById('conf-dre').value = state.admin.dre || 'Puriscal';

            // Cargar porcentajes
            const p = state.settings?.percentages || {
                iiiCiclo: { coti: 45, test: 40, task: 10, att: 5 },
                diversificado: { coti: 35, test: 50, task: 10, att: 5 }
            };

            document.getElementById('pct-iii-coti').value = p.iiiCiclo.coti;
            document.getElementById('pct-iii-test').value = p.iiiCiclo.test;
            document.getElementById('pct-iii-task').value = p.iiiCiclo.task;
            document.getElementById('pct-iii-att').value = p.iiiCiclo.att;

            document.getElementById('pct-div-coti').value = p.diversificado.coti;
            document.getElementById('pct-div-test').value = p.diversificado.test;
            document.getElementById('pct-div-task').value = p.diversificado.task;
            document.getElementById('pct-div-att').value = p.diversificado.att;

            renderGroups();
            lucide.createIcons();
        }

        function addGroup() {
            const lvl = document.getElementById('new-level').value;
            const sec = document.getElementById('new-section').value;

            if (!sec) return alert("Por favor, indica el número de sección.");

            const g = `${lvl}-${sec}`;

            if (!state.groups) state.groups = [];

            // Evitamos duplicados
            if (!state.groups.includes(g)) {
                state.groups.push(g);
                // Guardamos inmediatamente para no perder datos si cierras la pestaña
                localStorage.setItem('academicApp_2026_data', JSON.stringify(state));
                renderGroups(); // Actualiza el cuadro de la derecha
            } else {
                alert("Este grupo ya existe.");
            }

            document.getElementById('new-section').value = '';
        }

        function removeGroup(g) {
            if (confirm(`¿Eliminar el grupo ${g}?`)) {
                state.groups = state.groups.filter(item => item !== g);
                localStorage.setItem('academicApp_2026_data', JSON.stringify(state));
                renderGroups(); // Refresca la lista
            }
        }
        function renderGroups() {
            const list = document.getElementById('groups-list');
            list.innerHTML = (state.groups || []).sort().map(g => `
                <div class="flex items-center gap-2 px-3 py-1 bg-white border border-slate-100 rounded-lg text-[11px] font-bold text-slate-500 shadow-sm">
                    ${g} <button onclick="removeGroup('${g}')" class="text-slate-300 hover:text-rose-400">✕</button>
                </div>
            `).join('');
            lucide.createIcons();
        }

        function exportData() {
            const blob = new Blob([JSON.stringify(state)], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `Respaldo_Registro_2026.json`;
            a.click();
        }

        function saveConfig() {
            state.admin = {
                name: document.getElementById('conf-name').value,
                institution: document.getElementById('conf-inst').value,
                subject: document.getElementById('conf-subject').value,
                year: document.getElementById('conf-year').value,
                circuit: document.getElementById('conf-circuit').value,
                dre: document.getElementById('conf-dre').value
            };

            // Guardar porcentajes
            state.settings = state.settings || {};
            state.settings.percentages = {
                iiiCiclo: {
                    coti: parseFloat(document.getElementById('pct-iii-coti').value) || 45,
                    test: parseFloat(document.getElementById('pct-iii-test').value) || 40,
                    task: parseFloat(document.getElementById('pct-iii-task').value) || 10,
                    att: parseFloat(document.getElementById('pct-iii-att').value) || 5
                },
                diversificado: {
                    coti: parseFloat(document.getElementById('pct-div-coti').value) || 35,
                    test: parseFloat(document.getElementById('pct-div-test').value) || 50,
                    task: parseFloat(document.getElementById('pct-div-task').value) || 10,
                    att: parseFloat(document.getElementById('pct-div-att').value) || 5
                }
            };

            localStorage.setItem('academicApp_2026_data', JSON.stringify(state));
            window.location.href = 'index.html';
        }


        function toggleSidebar() {
            document.body.classList.toggle('sidebar-expanded');
        }
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>

</html>