<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>Diario de Clase</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="stylesheet" href="styles.css">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="icon-192.png">
    <link rel="apple-touch-icon" href="icon-512.png">
    <meta name="theme-color" content="#10b981">
    <style>
        .page-bitacora .nav-active {
            background: var(--primary-light);
            color: var(--primary-vibrant);
            box-shadow: var(--nm-shadow-in);
        }
    </style>
</head>

<body class="flex min-h-screen page-bitacora">
    <button class="sidebar-toggle no-print" onclick="toggleSidebar()">
        <i data-lucide="menu"></i>
    </button>
    <aside
        class="w-20 hover:w-64 bg-white border-r border-slate-100 transition-all duration-300 flex flex-col h-screen sticky top-0 z-40 overflow-hidden group">
        <div class="flex flex-col gap-3 p-4 mt-6">
            <a href="config.html"
                class="flex items-center gap-4 p-3 rounded-2xl text-slate-400 hover:bg-slate-50 transition-all">
                <i data-lucide="settings"></i>
                <span
                    class="opacity-0 group-hover:opacity-100 transition-opacity font-medium text-sm">Configuraci贸n</span>
            </a>
            <a href="index.html"
                class="flex items-center gap-4 p-3 rounded-2xl hover:bg-slate-50 text-slate-400 transition-all"
                id="nav-config">
                <i data-lucide="layout-dashboard"></i>
                <span class="opacity-0 group-hover:opacity-100 transition-opacity font-medium text-sm">Inicio</span>
            </a>
            <a href="estudiantes.html"
                class="flex items-center gap-4 p-3 rounded-2xl hover:bg-slate-50 text-slate-400 transition-all">
                <i data-lucide="users"></i>
                <span
                    class="opacity-0 group-hover:opacity-100 transition-opacity font-medium text-sm">Estudiantes</span>
            </a>
            <a href="bitacora.html" class="flex items-center gap-4 p-3 rounded-2xl nav-active">
                <i data-lucide="book-open"></i>
                <span class="opacity-0 group-hover:opacity-100 transition-opacity font-medium text-sm">Bit谩cora</span>
            </a>
            <a href="calendario.html"
                class="flex items-center gap-4 p-3 rounded-2xl text-slate-400 hover:bg-slate-50 transition-all">
                <i data-lucide="calendar"></i>
                <span class="opacity-0 group-hover:opacity-100 transition-opacity font-medium text-sm">Calendario</span>
            </a>
        </div>
    </aside>
    <main class="flex-1 p-10">
        <div class="max-w-7xl mx-auto">
            <header class="flex justify-between items-start mb-10">
                <div class="flex items-center gap-4">
                    <div class="icon-vibrant">
                        <i data-lucide="book-open"></i>
                    </div>
                    <div>
                        <h1>Diario de Clase</h1>
                        <div class="flex gap-4 mt-1">
                            <p
                                class="text-[9px] font-black text-slate-400 uppercase tracking-widest flex items-center gap-1">
                                <i data-lucide="home" class="w-3 h-3" style="color: var(--primary-vibrant);"></i> <span
                                    id="info-inst">---</span>
                            </p>
                            <p
                                class="text-[9px] font-black text-slate-400 uppercase tracking-widest flex items-center gap-1">
                                <i data-lucide="bookmark" class="w-3 h-3" style="color: var(--primary-vibrant);"></i>
                                <span id="info-subject">---</span>
                            </p>
                            <p
                                class="text-[9px] font-black text-slate-400 uppercase tracking-widest flex items-center gap-1">
                                <i data-lucide="user" class="w-3 h-3" style="color: var(--primary-vibrant);"></i> <span
                                    id="info-teacher">---</span>
                            </p>
                        </div>
                    </div>
                </div>

                <div class="flex items-center gap-4">
                    <div
                        class="bg-white px-6 py-2 rounded-full flex items-center gap-4 shadow-sm border border-slate-100">
                        <span class="text-[10px] font-black text-slate-300 uppercase">Ver d铆a:</span>
                        <input type="date" id="view-date" class="text-xs font-bold text-slate-600 outline-none"
                            onchange="renderDiary(); renderNotes();">
                    </div>
                    <button onclick="downloadDiaryPDF()" class="btn-nm">
                        <i data-lucide="printer" class="w-4 h-4 icon-vibrant"></i> Imprimir / PDF
                    </button>
                </div>
            </header>

            <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                <div class="lg:col-span-8 space-y-8">
                    <div class="card-premium relative">
                        <div class="flex justify-between items-center mb-8">
                            <h2>Actividades del D铆a</h2>
                            <span class="text-[11px] font-bold text-slate-300" id="date-display">---</span>
                        </div>
                        <div id="day-activities" class="space-y-6">
                        </div>
                    </div>

                    <div class="card-premium">
                        <div class="flex justify-between items-center">
                            <h2>Notas Especiales</h2>
                            <button onclick="addSpecialNote()" class="btn-nm">+ Agregar Nota</button>
                        </div>
                        <div id="special-notes-list" class="mt-6 space-y-3"></div>
                    </div>
                </div>

                <div class="lg:col-span-4 space-y-8">
                    <div class="card-premium relative overflow-hidden">
                        <div class="absolute -top-4 -right-4 w-20 h-20 bg-emerald-50 rounded-full opacity-50"></div>
                        <h2>Mis Pendientes</h2>
                        <div class="flex gap-2">
                            <input type="text" id="new-todo" placeholder="Agregar un pendiente..."
                                class="flex-1 bg-slate-50 border-none rounded-2xl p-4 text-sm font-medium focus:ring-2 focus:ring-emerald-500 outline-none">
                            <button onclick="addTodo()"
                                class="w-12 h-12 bg-emerald-500 text-white rounded-2xl flex items-center justify-center shadow-lg shadow-emerald-100 hover:bg-emerald-600"><i
                                    data-lucide="check" class="w-6 h-6"></i></button>
                        </div>
                        <div id="todo-list" class="mt-6 space-y-3"></div>
                    </div>

                    <div class="bg-amber-50/50 border border-amber-100 p-8 rounded-[2.5rem]">
                        <h3 class="text-amber-500 font-black text-sm mb-3 flex items-center gap-2"> Tip de Uso
                        </h3>
                        <p class="text-amber-700/70 text-xs font-bold leading-relaxed">
                            Las actividades aparecen aqu铆 seg煤n las fechas que asignaste en los rubros de <span
                                class="text-amber-600">Cotidiano y Tareas</span> en el registro principal.
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <script>
            let state = JSON.parse(localStorage.getItem('academicApp_2026_data')) || {};

            function init() {
                state = JSON.parse(localStorage.getItem('academicApp_2026_data')) || {};

                // Carga de Informaci贸n Profesional Din谩mica
                document.getElementById('info-inst').innerText = state.admin?.institution || 'Instituci贸n';
                document.getElementById('info-subject').innerText = state.admin?.subject || 'Materia';
                document.getElementById('info-teacher').innerText = state.admin?.name || 'Docente';

                const dateInput = document.getElementById('view-date');
                if (dateInput) dateInput.valueAsDate = new Date();

                renderDiary();
                renderTodos();
                renderNotes();

                lucide.createIcons();
            }

            function renderDiary() {
                const date = document.getElementById('view-date').value;
                const currentPeriod = state.settings?.currentPeriod || '1';
                document.getElementById('date-display').innerText = date;
                const container = document.getElementById('day-activities');
                let html = "";
                let hayActividadTotal = false;

                const niveles = Object.keys(state.students || {}).sort((a, b) => a - b);

                niveles.forEach(lvl => {
                    const secciones = [...new Set(state.students[lvl].map(s => s.section))].sort();

                    secciones.forEach(sec => {
                        const attData = state.attendance?.[currentPeriod]?.[date];
                        let tieneAsistencia = false;

                        if (attData) {
                            tieneAsistencia = state.students[lvl]
                                .filter(s => s.section === sec)
                                .some(s => attData[s.id] !== undefined);
                        }

                        const cot = Object.values(state.activities || {}).filter(a =>
                            a.level === lvl && a.section === sec && (a.dates || []).includes(date))
                            .map(a => ({ ...a, type: 'cot', icon: 'clipboard-list', label: 'Cotidiano', color: 'blue', link: 'cotidiano.html' }));

                        const tasks = Object.values(state.tasks || {}).filter(t =>
                            t.level === lvl && t.section === sec && (t.dates || []).includes(date))
                            .map(t => ({ ...t, type: 'task', icon: 'book', label: 'Tarea', color: 'purple', link: 'tareas.html' }));

                        const tests = Object.values(state.tests || {}).filter(t =>
                            t.level === lvl && t.section === sec && t.date === date)
                            .map(t => ({ ...t, type: 'test', icon: 'file-text', label: 'Prueba', color: 'rose', link: 'pruebas.html' }));

                        // Buscar comunicados del d铆a para estudiantes de esta secci贸n
                        const sectionStudentIds = (state.students[lvl] || []).filter(s => s.section === sec).map(s => s.id);
                        const comms = [];
                        sectionStudentIds.forEach(id => {
                            const studentComms = (state.commHistory?.[id] || []).filter(c => c.date === date);
                            studentComms.forEach(c => {
                                comms.push({
                                    name: `Env铆o de Comunicado ${c.type} (N掳 ${c.consecutive || '---'})`,
                                    label: 'Comunicado',
                                    icon: 'message-square',
                                    color: 'amber',
                                    link: 'comunicados.html'
                                });
                            });
                        });

                        // Eliminar duplicados si el mismo comunicado se envi贸 a varios (como en modo grupal)
                        const uniqueComms = [];
                        const seenComms = new Set();
                        comms.forEach(c => {
                            const key = `${c.name}`;
                            if (!seenComms.has(key)) {
                                uniqueComms.push(c);
                                seenComms.add(key);
                            }
                        });

                        if (tieneAsistencia || cot.length > 0 || tasks.length > 0 || tests.length > 0 || uniqueComms.length > 0) {
                            hayActividadTotal = true;

                            const combinedActivities = [...cot, ...tasks, ...tests, ...uniqueComms];

                            // AQU EMPIEZA EL DISEO CON ORILLAS
                            html += `
                <div class="mb-10 text-left border border-slate-100 p-8 rounded-[2.5rem] bg-white shadow-sm ring-1 ring-slate-50">
                    <div class="flex items-center gap-3 mb-6">
                        <div class="w-3 h-3 rounded-full bg-emerald-500 shadow-sm shadow-emerald-100"></div>
                        <h3 class="text-sm font-black text-slate-400 uppercase tracking-widest">Secci贸n ${lvl}-${sec}</h3>
                    </div>
                    
                    <div class="space-y-4 ml-2 mb-8">
                        ${tieneAsistencia ? `
                        <div class="bg-slate-50/50 border border-slate-100 p-5 rounded-3xl flex items-center justify-between group cursor-pointer hover:border-emerald-200 transition-all"
                             onclick="localStorage.setItem('temp_current_level','${lvl}'); localStorage.setItem('temp_current_section','${sec}'); location.href='asistencia.html'">
                            <div class="flex items-center gap-4">
                                <div class="w-12 h-12 bg-white rounded-2xl flex items-center justify-center text-emerald-500 shadow-sm shadow-emerald-100">
                                    <i data-lucide="clock" class="w-6 h-6 icon-vibrant" style="--primary-vibrant: var(--emerald-vibrant); --primary-light: var(--emerald-light);"></i>
                                </div>
                                <div>
                                    <p class="text-[10px] font-black text-emerald-500 uppercase tracking-widest">Asistencia</p>
                                    <p class="text-xs font-bold text-slate-700">Registro de Hoy</p>
                                </div>
                            </div>
                            <i data-lucide="arrow-right" class="w-5 h-5 text-slate-200 group-hover:text-emerald-400 transition-colors"></i>
                        </div>` : ''}

                        ${combinedActivities.map(a => `
                            <div class="bg-slate-50/50 border border-slate-100 p-5 rounded-3xl flex items-center justify-between group cursor-pointer hover:border-${a.color}-200 transition-all"
                                 onclick="localStorage.setItem('temp_current_level','${lvl}'); localStorage.setItem('temp_current_section','${sec}'); location.href='${a.link}'">
                                <div class="flex items-center gap-4">
                                    <div class="w-12 h-12 bg-white rounded-2xl flex items-center justify-center text-${a.color}-500 shadow-sm shadow-${a.color}-100">
                                        <i data-lucide="${a.icon}" class="w-6 h-6 icon-vibrant" style="--primary-vibrant: var(--${a.color}-vibrant); --primary-light: var(--${a.color}-light);"></i>
                                    </div>
                                    <div>
                                        <p class="text-[10px] font-black text-${a.color}-500 uppercase tracking-widest">${a.label}</p>
                                        <p class="text-xs font-bold text-slate-700">${a.name}</p>
                                    </div>
                                </div>
                                <i data-lucide="arrow-right" class="w-5 h-5 text-slate-200 group-hover:text-${a.color}-400 transition-colors"></i>
                            </div>
                        `).join('')}
                    </div>

                    <div class="mt-4">
                        <label class="text-[10px] font-black text-slate-300 uppercase ml-4 mb-2 block">Bit谩cora de la Lecci贸n</label>
                        <textarea 
                            class="w-full bg-emerald-50/30 border border-emerald-100 rounded-[2rem] p-6 text-sm font-medium text-slate-600 outline-none focus:bg-white focus:ring-2 focus:ring-emerald-400 transition-all min-h-[120px] resize-none overflow-hidden"
                            placeholder="Escribir observaciones de la lecci贸n..."
                            oninput="this.style.height = ''; this.style.height = this.scrollHeight + 'px'; saveDiaryNote('${lvl}-${sec}', '${date}', this.value)"
                        >${state.diaryNotes?.[date]?.[`${lvl}-${sec}`] || ''}</textarea>
                    </div>
                </div>`;
                        }
                    });
                });

                container.innerHTML = hayActividadTotal ? html : `<p class="text-slate-300 italic text-sm py-10">No hay registros para este d铆a.</p>`;
                lucide.createIcons();
            }
            // --- FUNCIONES PARA NOTAS ESPECIALES ---

            // Abrir y Cerrar Modal
            let editNoteId = null; // Variable global para rastrear si editamos

            function addSpecialNote() {
                editNoteId = null; // Reset para nueva nota
                document.getElementById('note-title').value = "";
                document.getElementById('note-detail').value = "";
                document.getElementById('modal-apunte').classList.remove('hidden');
                document.getElementById('note-title').focus();
            }

            // Nueva funci贸n para cargar los datos en el modal
            function editNote(id) {
                const date = document.getElementById('view-date').value;
                const note = state.specialNotes[date].find(n => n.id === id);

                if (note) {
                    editNoteId = id;
                    document.getElementById('note-title').value = note.title;
                    document.getElementById('note-detail').value = note.detail;
                    document.getElementById('modal-apunte').classList.remove('hidden');
                }
            }

            // Guardar la nota amarrada a la fecha seleccionada
            function saveSpecialNote() {
                const titleInput = document.getElementById('note-title');
                const detailInput = document.getElementById('note-detail');
                const date = document.getElementById('view-date').value;

                const title = titleInput.value.trim();
                const detail = detailInput.value.trim();

                if (!title) return alert("Por favor, dale un t铆tulo a tu apunte.");
                if (!date) return alert("Selecciona una fecha primero.");

                if (!state.specialNotes) state.specialNotes = {};
                if (!state.specialNotes[date]) state.specialNotes[date] = [];

                if (editNoteId) {
                    const index = state.specialNotes[date].findIndex(n => n.id === editNoteId);
                    if (index !== -1) {
                        state.specialNotes[date][index].title = title;
                        state.specialNotes[date][index].detail = detail;
                    }
                } else {
                    state.specialNotes[date].push({
                        id: Date.now(),
                        title: title,
                        detail: detail
                    });
                }

                // Guardamos y cerramos de inmediato
                saveDiaryData();
                closeNoteModal();
            }

            // Renderizar solo las notas del d铆a seleccionado
            function renderNotes() {
                const date = document.getElementById('view-date').value;
                const list = document.getElementById('special-notes-list');
                if (!list) return;

                // Filtramos para mostrar solo lo que corresponde a la fecha activa
                const notes = state.specialNotes?.[date] || [];

                if (notes.length === 0) {
                    list.innerHTML = `<p class="text-slate-300 italic text-[10px] text-center py-4 text-slate-400">No hay notas especiales para el ${date}.</p>`;
                    return;
                }

                list.innerHTML = notes.map(n => `
        <div class="group flex items-start justify-between p-5 bg-white border border-slate-50 rounded-[1.5rem] shadow-sm mb-3 hover:border-emerald-100 transition-all">
            <div class="flex gap-4">
                <span class="text-lg"></span>
                <div>
                    <p class="text-xs font-black text-slate-800 uppercase tracking-tight mb-1">${n.title}</p>
                    <p class="text-[11px] text-slate-500 font-medium leading-relaxed">${n.detail || ''}</p>
                </div>
            </div>
            <div class="flex gap-2 opacity-0 group-hover:opacity-100 transition-all">
                <div class="flex flex-col gap-1 mr-2 border-r border-slate-100 pr-2">
                    <button onclick="moveNoteUp(${n.id})" class="text-slate-300 hover:text-emerald-500 transition-all p-0.5">
                        <i data-lucide="chevron-up" class="w-4 h-4"></i>
                    </button>
                    <button onclick="moveNoteDown(${n.id})" class="text-slate-300 hover:text-emerald-500 transition-all p-0.5">
                        <i data-lucide="chevron-down" class="w-4 h-4"></i>
                    </button>
                </div>
                <button onclick="editNote(${n.id})" class="text-slate-300 hover:text-blue-500 transition-all p-1">
                    <i data-lucide="pencil" class="w-4 h-4"></i>
                </button>
                <button onclick="deleteNote(${n.id})" class="text-slate-300 hover:text-red-400 transition-all p-1">
                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                </button>
            </div>
        </div>
    `).join('');

                lucide.createIcons();
            }

            function deleteNote(id) {
                const date = document.getElementById('view-date').value;
                if (confirm("驴Borrar esta nota especial?")) {
                    state.specialNotes[date] = state.specialNotes[date].filter(n => n.id !== id);
                    saveDiaryData();
                }
            }

            function moveNoteUp(id) {
                const date = document.getElementById('view-date').value;
                const notes = state.specialNotes[date];
                const index = notes.findIndex(n => n.id === id);
                if (index > 0) {
                    [notes[index - 1], notes[index]] = [notes[index], notes[index - 1]];
                    saveDiaryData();
                }
            }

            function moveNoteDown(id) {
                const date = document.getElementById('view-date').value;
                const notes = state.specialNotes[date];
                const index = notes.findIndex(n => n.id === id);
                if (index < notes.length - 1) {
                    [notes[index], notes[index + 1]] = [notes[index + 1], notes[index]];
                    saveDiaryData();
                }
            }
            // Funci贸n para guardar las observaciones por nivel y fecha
            function saveDiaryNote(lvl, date, note) {
                if (!state.diaryNotes) state.diaryNotes = {};
                if (!state.diaryNotes[date]) state.diaryNotes[date] = {};
                state.diaryNotes[date][lvl] = note;
                localStorage.setItem('academicApp_2026_data', JSON.stringify(state));
            }
            function closeNoteModal() {
                const modal = document.getElementById('modal-apunte');
                if (modal) {
                    modal.classList.add('hidden'); // Esto es lo que lo oculta
                }
                // Limpiamos los campos para la pr贸xima vez
                document.getElementById('note-title').value = "";
                document.getElementById('note-detail').value = "";
                editNoteId = null;
            }
            // --- FUNCIONES DE MIS PENDIENTES ---

            function addTodo() {
                const input = document.getElementById('new-todo');
                const text = input.value.trim();

                if (!text) return;

                if (!state.todos) state.todos = [];

                state.todos.push({
                    id: Date.now(),
                    text: text,
                    done: false
                });

                input.value = "";
                saveDiaryData();
            }

            function toggleTodo(id) {
                const todo = state.todos.find(t => t.id === id);
                if (todo) {
                    todo.done = !todo.done;
                    saveDiaryData();
                }
            }

            function renderTodos() {
                const list = document.getElementById('todo-list');
                if (!list) return;

                if (!state.todos || state.todos.length === 0) {
                    list.innerHTML = "";
                    return;
                }

                list.innerHTML = state.todos.map(t => `
        <div class="flex items-center justify-between p-5 bg-white border border-slate-100 rounded-[1.5rem] mb-3 shadow-sm transition-all hover:border-emerald-200 group">
            <div class="flex items-center gap-4">
                <button onclick="toggleTodo(${t.id})" 
                    class="w-7 h-7 rounded-full border-2 flex items-center justify-center transition-all 
                    ${t.done ? 'bg-emerald-500 border-emerald-500' : 'border-slate-200'}">
                    ${t.done ? '<i data-lucide="check" class="w-4 h-4 text-white"></i>' : ''}
                </button>
                
                <span class="text-[13px] font-black tracking-tight ${t.done ? 'text-slate-300 line-through' : 'text-slate-700'}">
                    ${t.text}
                </span>
            </div>

            <button onclick="deleteTodo(${t.id})" 
                class="opacity-0 group-hover:opacity-100 p-2 text-slate-300 hover:text-red-500 transition-all">
                <i data-lucide="x" class="w-4 h-4"></i>
            </button>
        </div>
    `).join('');

                lucide.createIcons();
            }

            // Nueva funci贸n para eliminar el pendiente
            function deleteTodo(id) {
                if (confirm("驴Eliminar este pendiente?")) {
                    state.todos = state.todos.filter(t => t.id !== id);
                    saveDiaryData();
                }
            }

            // Funci贸n de guardado espec铆fica para evitar conflictos
            function saveDiaryData() {
                // Guardamos todo en la base de datos
                localStorage.setItem('academicApp_2026_data', JSON.stringify(state));

                // Redibujamos AMBAS listas para que se vean los cambios al instante
                renderTodos();
                renderNotes();
            }

            function save() {
                localStorage.setItem('academicApp_2026_data', JSON.stringify(state));
                renderDiary();
            }
            function downloadDiaryPDF() {
                const date = document.getElementById('view-date').value;
                const activitiesContainer = document.getElementById('day-activities').cloneNode(true);

                // Limpiamos los textareas para que el texto sea visible en el PDF
                activitiesContainer.querySelectorAll('textarea').forEach(tx => {
                    const textValue = tx.value;
                    const div = document.createElement('div');
                    div.style.cssText = "background: #f0fdf4; padding: 15px; border-radius: 10px; font-size: 12px; color: #475569; white-space: pre-wrap; margin-top: 10px; border: 1px solid #dcfce7;";
                    div.innerText = textValue || "Sin observaciones registradas.";
                    tx.parentNode.replaceChild(div, tx);
                });

                const activitiesHtml = activitiesContainer.innerHTML;
                const todos = (state.todos || []).filter(t => !t.done);
                const notes = state.specialNotes?.[date] || [];

                // Usamos un iframe oculto para evitar bloqueadores de popups en tablets
                let printFrame = document.getElementById('printFrame');
                if (!printFrame) {
                    printFrame = document.createElement('iframe');
                    printFrame.id = 'printFrame';
                    printFrame.style.display = 'none';
                    document.body.appendChild(printFrame);
                }

                const doc = printFrame.contentWindow.document;
                doc.open();
                doc.write(`
        <html>
        <head>
            <title>Diario - ${date}</title>
            <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;700;900&display=swap" rel="stylesheet">
            <style>
                body { font-family: 'Outfit', sans-serif; padding: 40px; color: #334155; }
                .header-pdf { display: flex; justify-content: space-between; align-items: flex-start; border-bottom: 3px solid #10b981; padding-bottom: 20px; margin-bottom: 30px; }
                .header-pdf h1 { margin: 0; font-size: 28px; font-weight: 900; text-transform: uppercase; color: #1e293b; letter-spacing: -1px; }
                .info-grid { text-align: right; font-size: 11px; font-weight: 700; color: #64748b; line-height: 1.5; }
                .info-grid b { color: #10b981; text-transform: uppercase; }
                h2 { font-size: 14px; font-weight: 900; text-transform: uppercase; color: #1e293b; margin-top: 30px; border-left: 5px solid #10b981; padding-left: 12px; margin-bottom: 15px; }
                .section-card { border: 1px solid #f1f5f9; padding: 25px; border-radius: 25px; margin-bottom: 20px; page-break-inside: avoid; background: #fafafa; }
                
                /* Layout de Actividades por columnas */
                .activities-wrapper { 
                    display: grid; 
                    grid-template-columns: repeat(2, 1fr); 
                    gap: 15px; 
                    margin-bottom: 20px;
                }
                .activities-wrapper > div { 
                    margin-top: 0 !important; /* Reset space-y-4 de Tailwind */
                    height: 100%;
                }
                
                .bitacora-full { grid-column: 1 / -1; width: 100%; margin-top: 20px; }

                .note-title { font-weight: 900; color: #10b981; text-transform: uppercase; font-size: 11px; margin-bottom: 5px; }
                .footer { margin-top: 50px; display: flex; justify-content: flex-end; }
                .signature { border-top: 2px solid #cbd5e1; width: 250px; text-align: center; padding-top: 8px; font-size: 10px; font-weight: 900; color: #94a3b8; text-transform: uppercase; }
                
                /* Ajustamos el contenedor de la secci贸n impreso */
                .mb-10 { page-break-inside: avoid; margin-bottom: 40px !important; }
                .space-y-4 { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 15px !important; }
                .mt-4 { margin-top: 15px !important; clear: both; }

                @media print { .no-print { display: none; } }
            </style>
        </head>
        <body>
            <div class="header-pdf">
                <div>
                    <h1>Diario de Clase</h1>
                    <p style="color:#10b981; font-weight:900; margin: 5px 0 0 0;">FECHA: ${date}</p>
                </div>
                <div class="info-grid">
                    <p>INSTITUCIN: <b>${state.admin?.institution || 'MEP'}</b></p>
                    <p>MATERIA: <b>${state.admin?.subject || 'PENDIENTE'}</b></p>
                    <p>DOCENTE: <b>${state.admin?.name || '---'}</b></p>
                </div>
            </div>
            <h2>Actividades por Secci贸n</h2>
            <div style="margin-top:20px;">${activitiesHtml}</div>
            
            ${notes.length > 0 ? `
                <h2>Notas Especiales</h2>
                ${notes.map(n => `<div class="section-card"><div class="note-title">${n.title}</div><div style="font-size: 12px; line-height: 1.6;">${n.detail}</div></div>`).join('')}
            ` : ''}

            <div class="footer">
                <div class="signature">Firma del Docente</div>
            </div>
        </body>
        </html>
    `);
                doc.close();

                // Esperamos a que cargue el contenido y disparamos impresi贸n
                setTimeout(() => {
                    printFrame.contentWindow.focus();
                    printFrame.contentWindow.print();
                }, 500);
            }
            function toggleSidebar() {
                document.body.classList.toggle('sidebar-expanded');
            }
            document.addEventListener('DOMContentLoaded', init);
        </script>
        <div id="modal-apunte"
            class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
            <div class="bg-white w-full max-w-md rounded-[2.5rem] shadow-2xl overflow-hidden p-10">
                <h2 class="text-xl font-black text-slate-800 mb-8 tracking-tighter">Agregar Apunte al D铆a</h2>

                <div class="space-y-4">
                    <input type="text" id="note-title" placeholder="Reuni贸n"
                        class="w-full bg-slate-50 border-none rounded-2xl p-4 text-sm font-bold text-slate-700 outline-none focus:ring-2 focus:ring-emerald-500">

                    <textarea id="note-detail" placeholder="Definici贸n de comit茅s"
                        class="w-full bg-slate-50 border-none rounded-2xl p-4 text-sm font-medium text-slate-600 outline-none focus:ring-2 focus:ring-emerald-500 h-32 resize-none"></textarea>
                </div>

                <div class="flex justify-end gap-6 items-center mt-10">
                    <button onclick="closeNoteModal()"
                        class="text-slate-400 font-bold text-sm uppercase tracking-widest hover:text-slate-600">Cancelar</button>
                    <button onclick="saveSpecialNote()"
                        class="bg-emerald-500 text-white px-8 py-4 rounded-[1.5rem] text-sm font-black uppercase tracking-widest shadow-lg shadow-emerald-100 hover:bg-emerald-600 transition-all">Guardar
                        Nota</button>
                </div>
            </div>
        </div>
        </div>
</body>

</html>