<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>Calendario Académico</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="stylesheet" href="styles.css">
    <style>
        .page-calendario .nav-active {
            background: var(--primary-light);
            color: var(--primary-vibrant);
            box-shadow: var(--nm-shadow-in);
        }

        .day-cell {
            min-height: 120px;
            transition: all 0.3s;
            border: 1px solid #f1f5f9;
        }

        .day-cell:hover {
            background: #ffffff;
            transform: scale(1.02);
            z-index: 10;
            box-shadow: var(--nm-shadow-out);
            border-radius: 1rem;
        }

        .event-tag {
            font-size: 8px;
            font-weight: 900;
            padding: 4px 8px;
            border-radius: 8px;
            margin-top: 4px;
            display: flex;
            align-items: center;
            gap: 4px;
            text-transform: uppercase;
            box-shadow: 2px 2px 4px rgba(0, 0, 0, 0.02);
        }

        .icon-selector-btn {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            background: #f8fafc;
            color: #94a3b8;
            transition: all 0.3s;
            cursor: pointer;
            border: 2px solid transparent;
        }

        .icon-selector-btn.active {
            background: #eef2ff;
            color: #4f46e5;
            border-color: #4f46e5;
            transform: scale(1.1);
        }

        .icon-selector-btn:hover:not(.active) {
            background: #f1f5f9;
            color: #64748b;
        }
    </style>
</head>

<body class="flex min-h-screen page-calendario">
    <aside
        class="w-20 hover:w-64 bg-white border-r border-slate-100 transition-all duration-300 flex flex-col h-screen sticky top-0 z-40 overflow-hidden group">
        <div class="flex flex-col gap-3 p-4 mt-6">
            <a href="config.html"
                class="flex items-center gap-4 p-3 rounded-2xl text-slate-400 hover:bg-slate-50 transition-all">
                <i data-lucide="users"></i>
                <span
                    class="opacity-0 group-hover:opacity-100 transition-opacity font-medium text-sm">Configuración</span>
            </a>
            <a href="index.html"
                class="flex items-center gap-4 p-3 rounded-2xl hover:bg-slate-50 text-slate-400 transition-all"
                id="nav-config">
                <i data-lucide="settings"></i>
                <span class="opacity-0 group-hover:opacity-100 transition-opacity font-medium text-sm">Inicio</span>
            </a>
            <a href="estudiantes.html"
                class="flex items-center gap-4 p-3 rounded-2xl hover:bg-slate-50 text-slate-400 transition-all">
                <i data-lucide="layout-dashboard"></i>
                <span
                    class="opacity-0 group-hover:opacity-100 transition-opacity font-medium text-sm">Estudiantes</span>
            </a>
            <a href="bitacora.html"
                class="flex items-center gap-4 p-3 rounded-2xl text-slate-400 hover:bg-slate-50 transition-all">
                <i data-lucide="book-open"></i>
                <span class="opacity-0 group-hover:opacity-100 transition-opacity font-medium text-sm">Bitácora</span>
            </a>
            <a href="calendario.html" class="flex items-center gap-4 p-3 rounded-2xl nav-active">
                <i data-lucide="calendar"></i>
                <span class="opacity-0 group-hover:opacity-100 transition-opacity font-medium text-sm">Calendario</span>
            </a>
        </div>
    </aside>
    <main class="flex-1 p-10">
        <header class="flex justify-between items-center mb-10">
            <div class="flex items-center gap-4">
                <div class="icon-vibrant">
                    <i data-lucide="calendar"></i>
                </div>
                <div>
                    <h1>Calendario Escolar</h1>
                    <div class="flex gap-4 mt-1">
                        <p
                            class="text-[9px] font-black text-slate-400 uppercase tracking-widest flex items-center gap-1">
                            <i data-lucide="home" class="w-3 h-3" style="color: var(--primary-vibrant);"></i> <span
                                id="info-inst">---</span>
                        </p>
                        <p
                            class="text-[9px] font-black text-slate-400 uppercase tracking-widest flex items-center gap-1">
                            <i data-lucide="bookmark" class="w-3 h-3" style="color: var(--primary-vibrant);"></i>
                            <span id="info-subject">---</span>
                        </p>
                        <p
                            class="text-[9px] font-black text-slate-400 uppercase tracking-widest flex items-center gap-1">
                            <i data-lucide="user" class="w-3 h-3" style="color: var(--primary-vibrant);"></i> <span
                                id="info-teacher">---</span>
                        </p>
                    </div>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <button onclick="openEventModal()" class="btn-nm">
                    <i data-lucide="plus" class="w-4 h-4 icon-vibrant"></i> Nuevo Evento
                </button>
                <button onclick="location.href='index.html'" class="btn-nm">
                    <i data-lucide="arrow-left" class="w-4 h-4 icon-vibrant"></i> Volver
                </button>
            </div>
        </header>

        <div class="grid grid-cols-12 gap-8">
            <div class="col-span-9">
                <div class="card-premium">
                    <div class="flex justify-between items-center mb-10">
                        <div class="flex items-center gap-6">
                            <button onclick="changeMonth(-1)"
                                class="p-2 hover:bg-slate-50 rounded-full text-slate-400"><i
                                    data-lucide="chevron-left"></i></button>
                            <h2 id="current-month-display"
                                class="text-2xl font-black text-slate-800 uppercase tracking-tighter min-w-[200px] text-center">
                                Febrero 2026</h2>
                            <button onclick="changeMonth(1)"
                                class="p-2 hover:bg-slate-50 rounded-full text-slate-400"><i
                                    data-lucide="chevron-right"></i></button>
                        </div>
                    </div>

                    <div class="grid grid-cols-7 border border-slate-100 rounded-[2rem] overflow-hidden bg-slate-50/30">
                        <script>
                            // Usamos document.write para que el JS no se escape como texto
                            document.write(['Lun', 'Mar', 'Mie', 'Jue', 'Vie', 'Sab', 'Dom'].map(d => `
                        <div class="p-4 text-center text-[10px] font-black text-slate-300 uppercase tracking-widest border-b border-slate-100 bg-slate-50/50">
                            ${d}
                        </div>`).join(''));
                        </script>
                        <div id="calendar-grid" class="contents"></div>
                    </div>
                </div>
            </div>
            <div class="col-span-3 space-y-8">
                <div class="card-premium relative overflow-hidden min-h-[500px]">
                    <div class="absolute -top-4 -right-4 w-20 h-20 bg-emerald-50 rounded-full opacity-50"></div>
                    <h2 class="text-lg font-black text-slate-700 flex items-center gap-2 mb-8 mt-2"><i data-lucide="pin"
                            class="w-5 h-5 text-red-400 fill-red-400"></i> Mis Pendientes</h2>
                    <div class="flex gap-2 mb-6">
                        <input type="text" id="new-todo" placeholder="Agregar un pendiente..."
                            class="flex-1 bg-slate-50 border-none rounded-2xl p-4 text-xs font-medium focus:ring-2 focus:ring-emerald-500 outline-none">
                        <button onclick="addTodo()"
                            class="w-12 h-12 bg-emerald-500 text-white rounded-2xl flex items-center justify-center shadow-lg shadow-emerald-100"><i
                                data-lucide="check" class="w-6 h-6"></i></button>
                    </div>
                    <div id="todo-list" class="space-y-3"></div>
                </div>
            </div>


        </div>
        </div>

        <div id="modal-evento"
            class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
            <div class="bg-white w-full max-w-lg rounded-[2.5rem] shadow-2xl p-10">
                <h2 id="modal-title" class="section-title">Agregar Evento</h2>
                <div class="space-y-4">
                    <div class="flex gap-4 items-center">
                        <div class="flex-1">
                            <label class="text-[10px] font-black text-slate-400 uppercase mb-1 block">Título</label>
                            <input type="text" id="ev-title" placeholder="Nombre de la actividad"
                                class="w-full bg-slate-50 border-none rounded-2xl p-4 text-sm font-bold outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                    </div>
                    <div>
                        <label class="text-[10px] font-black text-slate-400 uppercase mb-1 block">Seleccionar
                            Ícono</label>
                        <div class="flex gap-2 flex-wrap bg-slate-50/50 p-2 rounded-2xl border border-slate-100">
                            <input type="hidden" id="ev-icon" value="bell">
                            <div onclick="selectIcon('bell')" class="icon-selector-btn icon-choice active"
                                data-choice="bell"><i data-lucide="bell" class="w-5 h-5"></i></div>
                            <div onclick="selectIcon('star')" class="icon-selector-btn icon-choice" data-choice="star">
                                <i data-lucide="star" class="w-5 h-5"></i>
                            </div>
                            <div onclick="selectIcon('book')" class="icon-selector-btn icon-choice" data-choice="book">
                                <i data-lucide="book" class="w-5 h-5"></i>
                            </div>
                            <div onclick="selectIcon('users')" class="icon-selector-btn icon-choice"
                                data-choice="users"><i data-lucide="users" class="w-5 h-5"></i></div>
                            <div onclick="selectIcon('clock')" class="icon-selector-btn icon-choice"
                                data-choice="clock"><i data-lucide="clock" class="w-5 h-5"></i></div>
                            <div onclick="selectIcon('alert-circle')" class="icon-selector-btn icon-choice"
                                data-choice="alert-circle"><i data-lucide="alert-circle" class="w-5 h-5"></i></div>
                            <div onclick="selectIcon('award')" class="icon-selector-btn icon-choice"
                                data-choice="award"><i data-lucide="award" class="w-5 h-5"></i></div>
                            <div onclick="selectIcon('coffee')" class="icon-selector-btn icon-choice"
                                data-choice="coffee"><i data-lucide="coffee" class="w-5 h-5"></i></div>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <input type="date" id="ev-date"
                            class="bg-slate-50 border-none rounded-2xl p-4 text-sm font-bold outline-none">
                        <input type="time" id="ev-time"
                            class="bg-slate-50 border-none rounded-2xl p-4 text-sm font-bold outline-none">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-[10px] font-black text-slate-400 uppercase mb-1 block">Repetir</label>
                            <select id="ev-repeat" onchange="toggleCustomDays()"
                                class="w-full bg-slate-50 border-none rounded-2xl p-4 text-sm font-bold outline-none">
                                <option value="none">No repetir</option>
                                <option value="daily">Diario</option>
                                <option value="weekly">Semanal</option>
                                <option value="monthly">Mensual</option>
                                <option value="custom">Cada X días</option>
                            </select>
                        </div>
                        <div id="custom-days-container" class="hidden">
                            <label class="text-[10px] font-black text-slate-400 uppercase mb-1 block">Frecuencia
                                (Días)</label>
                            <input type="number" id="ev-frequency" value="1" min="1"
                                class="w-full bg-slate-50 border-none rounded-2xl p-4 text-sm font-bold outline-none">
                        </div>
                    </div>
                    <textarea id="ev-obs" placeholder="Observaciones adicionales..."
                        class="w-full bg-slate-50 border-none rounded-2xl p-4 text-sm font-medium h-32 resize-none outline-none focus:ring-2 focus:ring-indigo-500"></textarea>
                </div>
                <div class="flex justify-between items-center mt-10">
                    <button id="delete-event-btn" onclick="deleteEvent()"
                        class="text-red-400 font-bold text-xs uppercase tracking-widest hidden">Eliminar</button>
                    <div class="flex gap-6 items-center ml-auto">
                        <button onclick="closeEventModal()"
                            class="text-slate-400 font-bold text-xs uppercase tracking-widest">Cancelar</button>
                        <button onclick="saveEvent()"
                            class="bg-indigo-600 text-white px-8 py-4 rounded-[1.5rem] text-xs font-black uppercase tracking-widest hover:bg-indigo-700 transition-all">Guardar
                            Evento</button>
                    </div>
                </div>
            </div>
        </div>

        <script>
            let state = JSON.parse(localStorage.getItem('academicApp_2026_data')) || {};
            let currentDate = new Date(2026, 1, 1); // Empezamos en Feb 2026
            let editingEventId = null;

            function init() {
                // 1. Cargamos el estado más reciente
                state = JSON.parse(localStorage.getItem('academicApp_2026_data')) || {};

                // 2. Cargamos la información profesional (IDs corregidos)
                document.getElementById('info-teacher').innerText = state.admin?.name || 'Docente';
                document.getElementById('info-inst').innerText = state.admin?.institution || 'Institución';
                document.getElementById('info-subject').innerText = state.admin?.subject || 'Materia';

                // 3. Renderizamos el resto de componentes
                renderCalendar();
                renderTodos();

                // 4. Activamos los iconos de Lucide
                lucide.createIcons();
            }

            function renderCalendar() {
                const grid = document.getElementById('calendar-grid');
                const monthDisplay = document.getElementById('current-month-display');
                grid.innerHTML = "";

                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();
                monthDisplay.innerText = new Intl.DateTimeFormat('es-ES', { month: 'long', year: 'numeric' }).format(currentDate);

                const firstDay = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const startOffset = firstDay === 0 ? 6 : firstDay - 1;

                // Espacios vacíos
                for (let i = 0; i < startOffset; i++) {
                    grid.innerHTML += `<div class="day-cell bg-slate-50/20"></div>`;
                }

                // Días del mes
                for (let day = 1; day <= daysInMonth; day++) {
                    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;

                    // 1. Buscamos Evaluaciones del Registro (Cotidiano, Tareas, Pruebas)
                    const evalTags = getEvaluationsForDate(dateStr);

                    // 2. Buscamos Eventos Propios
                    const customEvents = (state.calendarEvents || []).filter(ev => isEventOnDate(ev, dateStr));

                    grid.innerHTML += `
                    <div class="day-cell p-4 border-r border-b border-slate-50 bg-white">
                        <span class="text-xs font-black ${new Date().toISOString().split('T')[0] === dateStr ? 'text-indigo-600' : 'text-slate-400'}">${day}</span>
                        <div class="mt-2 space-y-1">
                            ${evalTags}
                            ${customEvents.map(ev => `
                                <div onclick="editEvent(${ev.id})" class="event-tag bg-indigo-50 text-indigo-500 cursor-pointer hover:bg-indigo-100">
                                    <i data-lucide="${ev.icon || 'bell'}" class="w-2.5 h-2.5"></i> ${ev.title}
                                    ${ev.repeat && ev.repeat !== 'none' ? '<i data-lucide="refresh-cw" class="w-2 h-2 ml-1 opacity-50"></i>' : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>`;
                }
                lucide.createIcons();
            }

            function getEvaluationsForDate(date) {
                let tags = "";
                // Recorremos actividades (Cotidianos)
                Object.values(state.activities || {}).forEach(a => {
                    if (a.dates && a.dates.includes(date)) {
                        tags += `<div class="event-tag bg-emerald-50 text-emerald-600"><i data-lucide="edit-3" class="w-2.5 h-2.5"></i> ${a.level}-${a.section} COT</div>`;
                    }
                });
                // Recorremos tareas
                Object.values(state.tasks || {}).forEach(t => {
                    if (t.dates && t.dates.includes(date)) {
                        tags += `<div class="event-tag bg-blue-50 text-blue-600"><i data-lucide="book" class="w-2.5 h-2.5"></i> ${t.level}-${t.section} TAR</div>`;
                    }
                });
                return tags;
            }

            function isEventOnDate(ev, dateStr) {
                if (ev.date === dateStr) return true;
                if (!ev.repeat || ev.repeat === 'none') return false;

                const start = new Date(ev.date + 'T00:00:00');
                const current = new Date(dateStr + 'T00:00:00');

                if (current < start) return false;

                const diffDays = Math.floor((current - start) / (1000 * 60 * 60 * 24));

                switch (ev.repeat) {
                    case 'daily': return true;
                    case 'weekly': return diffDays % 7 === 0;
                    case 'monthly': return current.getDate() === start.getDate();
                    case 'custom': return diffDays % (ev.frequency || 1) === 0;
                    default: return false;
                }
            }

            // --- Gestión de Eventos ---
            function openEventModal() {
                editingEventId = null;
                document.getElementById('modal-title').innerText = "AGREGAR EVENTO";
                document.getElementById('ev-title').value = "";
                document.getElementById('ev-date').value = new Date().toISOString().split('T')[0];
                document.getElementById('ev-time').value = "07:00";
                document.getElementById('ev-obs').value = "";
                document.getElementById('ev-repeat').value = "none";
                document.getElementById('ev-frequency').value = "1";
                document.getElementById('delete-event-btn').classList.add('hidden');
                toggleCustomDays();
                // Reset icon
                selectIcon('bell');
                document.getElementById('modal-evento').classList.remove('hidden');
                lucide.createIcons();
            }

            function toggleCustomDays() {
                const repeat = document.getElementById('ev-repeat').value;
                document.getElementById('custom-days-container').classList.toggle('hidden', repeat !== 'custom');
            }

            function selectIcon(iconName) {
                document.getElementById('ev-icon').value = iconName;
                document.querySelectorAll('.icon-choice').forEach(el => {
                    el.classList.toggle('active', el.getAttribute('data-choice') === iconName);
                });
            }

            function editEvent(id) {
                const ev = state.calendarEvents.find(e => e.id === id);
                if (ev) {
                    editingEventId = id;
                    document.getElementById('modal-title').innerText = "EDITAR EVENTO";
                    document.getElementById('ev-title').value = ev.title;
                    document.getElementById('ev-date').value = ev.date;
                    document.getElementById('ev-time').value = ev.time;
                    document.getElementById('ev-obs').value = ev.obs;
                    document.getElementById('ev-repeat').value = ev.repeat || "none";
                    document.getElementById('ev-frequency').value = ev.frequency || "1";
                    document.getElementById('delete-event-btn').classList.remove('hidden');
                    toggleCustomDays();
                    selectIcon(ev.icon || 'bell');
                    document.getElementById('modal-evento').classList.remove('hidden');
                    lucide.createIcons();
                }
            }

            function saveEvent() {
                const ev = {
                    id: editingEventId || Date.now(),
                    title: document.getElementById('ev-title').value,
                    date: document.getElementById('ev-date').value,
                    time: document.getElementById('ev-time').value,
                    obs: document.getElementById('ev-obs').value,
                    icon: document.getElementById('ev-icon').value,
                    repeat: document.getElementById('ev-repeat').value,
                    frequency: parseInt(document.getElementById('ev-frequency').value) || 1
                };

                if (!state.calendarEvents) state.calendarEvents = [];
                if (editingEventId) {
                    const idx = state.calendarEvents.findIndex(e => e.id === editingEventId);
                    state.calendarEvents[idx] = ev;
                } else {
                    state.calendarEvents.push(ev);
                }

                saveData();
                closeEventModal();
                renderCalendar();
            }

            function deleteEvent() {
                if (!editingEventId) return;
                if (confirm("¿Eliminar este evento?")) {
                    state.calendarEvents = state.calendarEvents.filter(e => e.id !== editingEventId);
                    saveData();
                    closeEventModal();
                    renderCalendar();
                }
            }

            // --- Pendientes (Sincronizados con Bitácora/Diario) ---
            function addTodo() {
                const input = document.getElementById('new-todo');
                if (!input.value) return;
                if (!state.todos) state.todos = [];
                state.todos.unshift({ id: Date.now(), text: input.value, done: false });
                input.value = "";
                saveData();
                renderTodos();
            }

            function renderTodos() {
                const list = document.getElementById('todo-list');
                list.innerHTML = (state.todos || []).map(t => `
        <div class="flex items-center justify-between p-4 bg-slate-50 border border-slate-100 rounded-2xl group transition-all hover:bg-white hover:shadow-sm">
            <div class="flex items-center gap-3">
                <button onclick="toggleTodo(${t.id})" class="w-6 h-6 rounded-full border-2 flex items-center justify-center transition-colors ${t.done ? 'bg-emerald-500 border-emerald-500 text-white' : 'border-slate-200'}">
                    ${t.done ? '<i data-lucide="check" class="w-4 h-4"></i>' : ''}
                </button>
                <span class="text-xs font-black ${t.done ? 'text-slate-300 line-through' : 'text-slate-700'}">${t.text}</span>
            </div>
            <button onclick="deleteTodo(${t.id})" class="opacity-0 group-hover:opacity-100 p-2 text-slate-300 hover:text-red-500 transition-all">
                <i data-lucide="trash-2" class="w-4 h-4"></i>
            </button>
        </div>`).join('');
                lucide.createIcons(); // Importante para que aparezca el basurero
            }
            function deleteTodo(id) {
                // Filtramos la lista para quitar el pendiente con ese ID
                state.todos = state.todos.filter(t => t.id !== id);
                saveData(); // Guarda el cambio para que se refleje en la bitácora también
                renderTodos(); // Refresca la lista visualmente
            }
            function toggleTodo(id) {
                const t = state.todos.find(x => x.id === id);
                if (t) t.done = !t.done;
                saveData();
                renderTodos();
            }

            function saveData() {
                localStorage.setItem('academicApp_2026_data', JSON.stringify(state));
            }

            function changeMonth(step) {
                currentDate.setMonth(currentDate.getMonth() + step);
                renderCalendar();
            }

            function closeEventModal() { document.getElementById('modal-evento').classList.add('hidden'); }

            document.addEventListener('DOMContentLoaded', init);
        </script>
        </div>
</body>

</html>