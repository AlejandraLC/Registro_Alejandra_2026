<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asistencia - Registro 2026</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="stylesheet" href="styles.css">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/svg+xml" href="icon.svg">
    <link rel="apple-touch-icon" href="icon.svg">
    <meta name="theme-color" content="#10b981">
    <style>
        .page-asistencia .nav-active {
            background: var(--primary-light);
            color: var(--primary-vibrant);
            box-shadow: var(--nm-shadow-in);
        }

        .btn-status {
            padding: 0.5rem 1rem;
            border-radius: 1rem;
            font-size: 0.75rem;
            font-weight: 800;
            transition: all 0.3s;
            border: 1px solid transparent;
            box-shadow: var(--nm-shadow-out);
        }

        .active-p {
            background: #f0fdf4;
            color: #16a34a;
            border-color: #dcfce7;
            box-shadow: var(--nm-shadow-in);
        }

        .active-ai {
            background: #fef2f2;
            color: #ef4444;
            border-color: #fee2e2;
            box-shadow: var(--nm-shadow-in);
        }

        .active-aj {
            background: #f0f9ff;
            color: #0ea5e9;
            border-color: #e0f2fe;
            box-shadow: var(--nm-shadow-in);
        }

        .active-t {
            background: #fffbeb;
            color: #d97706;
            border-color: #fef3c7;
            box-shadow: var(--nm-shadow-in);
        }

        .inactive {
            background: #f8fafc;
            color: #94a3b8;
            border-color: #f1f5f9;
        }

        /* Override global input styles for small lesson inputs */
        .input-lesson-small {
            width: 3.5rem !important;
            padding: 0.3rem 0.5rem !important;
            height: auto !important;
            text-align: center !important;
            font-size: 0.8rem !important;
            font-weight: 900 !important;
            background: #f1f5f9 !important;
            box-shadow: inset 2px 2px 4px #cbd5e1 !important;
            border-radius: 0.75rem !important;
            color: #334155 !important;
            border: 1px solid transparent !important;
        }

        .input-lesson-small:focus {
            background: #ffffff !important;
            border-color: var(--primary-color) !important;
            box-shadow: var(--nm-shadow-out) !important;
        }
    </style>
</head>

<body class="flex min-h-screen page-asistencia">
    <button class="sidebar-toggle no-print" onclick="toggleSidebar()">
        <i data-lucide="menu"></i>
    </button>
    <aside
        class="w-20 hover:w-64 bg-white border-r border-slate-100 transition-all duration-300 flex flex-col h-screen sticky top-0 z-40 overflow-hidden group">
        <div class="flex flex-col gap-3 p-4 mt-6">
            <a href="config.html"
                class="flex items-center gap-4 p-3 rounded-2xl text-slate-400 hover:bg-slate-50 transition-all">
                <i data-lucide="settings"></i>
                <span
                    class="opacity-0 group-hover:opacity-100 transition-opacity font-medium text-sm">Configuración</span>
            </a>
            <a href="index.html"
                class="flex items-center gap-4 p-3 rounded-2xl hover:bg-slate-50 text-slate-400 transition-all">
                <i data-lucide="layout-dashboard"></i>
                <span class="opacity-0 group-hover:opacity-100 transition-opacity font-medium text-sm">Inicio</span>
            </a>
            <a href="estudiantes.html"
                class="flex items-center gap-4 p-3 rounded-2xl hover:bg-slate-50 text-slate-400 transition-all">
                <i data-lucide="users"></i>
                <span
                    class="opacity-0 group-hover:opacity-100 transition-opacity font-medium text-sm">Estudiantes</span>
            </a>
            <a href="bitacora.html"
                class="flex items-center gap-4 p-3 rounded-2xl text-slate-400 hover:bg-slate-50 transition-all">
                <i data-lucide="book-open"></i>
                <span class="opacity-0 group-hover:opacity-100 transition-opacity font-medium text-sm">Bitácora</span>
            </a>
            <a href="calendario.html"
                class="flex items-center gap-4 p-3 rounded-2xl text-slate-400 hover:bg-slate-50 transition-all">
                <i data-lucide="calendar"></i>
                <span class="opacity-0 group-hover:opacity-100 transition-opacity font-medium text-sm">Calendario</span>
            </a>
        </div>
    </aside>

    <main class="flex-1 p-8">
        <header class="page-title mb-8 flex items-center justify-between border-b border-slate-100 pb-6 uppercase">
            <h1><i data-lucide="clock" class="title-icon icon-vibrant"></i> Asistencia</h1>
            <div
                class="flex items-center gap-3 bg-white px-4 py-1.5 rounded-full border border-slate-100 shadow-sm text-xs font-bold text-slate-600">
                <span id="display-group">---</span> <span class="text-slate-200">|</span> <span id="display-period"
                    class="text-blue-500">P-I</span>
            </div>
            <div class="flex items-center gap-6 text-[10px] font-medium text-slate-400">
                <p>Institución: <span class="text-slate-600 font-bold" id="info-inst">---</span></p>
                <p>Materia: <span class="text-slate-600 font-bold" id="info-subject">---</span></p>
                <p>Docente: <span class="text-slate-600 font-bold" id="info-teacher">---</span></p>
            </div>
        </header>

        <div class="flex flex-wrap items-center justify-between gap-4 mb-8">
            <div class="flex items-center gap-4 bg-white p-4 rounded-[1.5rem] border border-slate-100 shadow-sm">
                <div>
                    <label class="text-[9px] font-black text-slate-300 uppercase block mb-1">Fecha</label>
                    <input type="date" id="att-date" class="text-sm font-bold text-slate-600 outline-none"
                        onchange="renderAttendance()">
                </div>
                <div class="w-px h-8 bg-slate-100"></div>
                <div>
                    <label class="text-[9px] font-black text-slate-300 uppercase block mb-1">Lecciones</label>
                    <input type="number" id="day-lessons" value="2" class="input-lesson-small"
                        onchange="updateAllLessons()">
                </div>
                <button onclick="deleteDate()" class="p-2 text-slate-300 hover:text-red-400 transition-all"><i
                        data-lucide="trash-2" class="w-4 h-4"></i></button>
            </div>

            <div class="bg-blue-50 border border-blue-100 p-4 rounded-[1.5rem] text-center px-8">
                <p class="text-[9px] font-black text-blue-400 uppercase tracking-widest">Total Lecciones Periodo</p>
                <p class="text-xl font-black text-blue-600" id="total-lessons-period">0</p>
            </div>

            <div class="flex gap-4">
                <button onclick="showHistory()" class="btn-nm">
                    <i data-lucide="clock" class="w-4 h-4 icon-vibrant"></i> Histórico
                </button>
                <button onclick="downloadPDF()" class="btn-nm">
                    <i data-lucide="printer" class="w-4 h-4 icon-vibrant"></i> PDF / Imprimir
                </button>
                <button onclick="location.href='index.html'" class="btn-nm">
                    <i data-lucide="arrow-left" class="w-4 h-4 icon-vibrant"></i> Volver
                </button>
            </div>
        </div>

        <div class="bg-white rounded-[2rem] border border-slate-100 overflow-hidden shadow-sm">
            <table class="w-full text-left">
                <thead class="bg-slate-50 text-[9px] font-black text-slate-400 uppercase tracking-[0.15em]">
                    <tr>
                        <th class="p-5">Estudiante</th>
                        <th class="p-5 text-center">Estado</th>
                        <th class="p-5 text-center">Lecciones</th>
                        <th class="p-5 text-center bg-slate-100/30">AI</th>
                        <th class="p-5 text-center bg-slate-100/30">AJ</th>
                        <th class="p-5 text-center bg-slate-100/30">T</th>
                        <th class="p-5 text-right pr-10 text-blue-500">Nota (5%)</th>
                    </tr>
                </thead>
                <tbody id="att-body"></tbody>
            </table>
        </div>
    </main>

    <script>
        // Recuperamos el estado global y las variables de navegación
        let state = JSON.parse(localStorage.getItem('academicApp_2026_data')) || { students: {}, attendance: {}, admin: {}, settings: {} };
        const lvl = localStorage.getItem('temp_current_level') || '7';
        const sec = localStorage.getItem('temp_current_section') || '1';
        const period = state.settings?.currentPeriod || '1';

        // Inicialización de la página
        function init() {
            document.getElementById('att-date').valueAsDate = new Date();
            document.getElementById('display-group').innerText = `${lvl}-${sec}`;
            document.getElementById('display-period').innerText = `P-${period}`;
            document.getElementById('info-inst').innerText = state.admin?.institution || 'MEP';
            document.getElementById('info-subject').innerText = state.admin?.subject || 'Mate';
            document.getElementById('info-teacher').innerText = state.admin?.name || '---';

            renderAttendance();
            lucide.createIcons();
        }

        // Renderizado de la lista con cálculos en tiempo real
        function renderAttendance() {
            const date = document.getElementById('att-date').value;
            const students = (state.students[lvl] || []).filter(s => s.section === sec).sort((a, b) => a.name.localeCompare(b.name));
            const tbody = document.getElementById('att-body');

            // Sincronizar el input global de lecciones si ya hay registros para ese día
            const periodData = state.attendance?.[period]?.[date] || {};
            const records = Object.values(periodData);
            if (records.length > 0) {
                const dailyMax = Math.max(...records.map(r => r.lessons || 0), 0);
                document.getElementById('day-lessons').value = dailyMax;
            }

            const dayLec = parseInt(document.getElementById('day-lessons').value) || 2;

            // Sumatoria total de lecciones dadas en el periodo
            const totalLecPeriodo = calculateTotalLessons();
            document.getElementById('total-lessons-period').innerText = totalLecPeriodo;

            tbody.innerHTML = students.map(s => {
                // Obtenemos el registro de hoy o creamos uno por defecto (Presente)
                const todayRecord = getRecord(s.id, date) || { status: 'P', lessons: dayLec };
                const stats = calculateStats(s.id);
                const grade = calculateGrade(stats.ai, stats.t, totalLecPeriodo);

                return `
        <tr class="border-t border-slate-50 group hover:bg-slate-50/30 transition-all">
            <td class="p-5 font-bold text-slate-700 text-sm">${s.name}</td>
            <td class="p-5">
                <div class="flex justify-center gap-1">
                    <button onclick="setStatus('${s.id}', 'P')" class="btn-status ${todayRecord.status === 'P' ? 'active-p' : 'inactive'}">P</button>
                    <button onclick="setStatus('${s.id}', 'AI')" class="btn-status ${todayRecord.status === 'AI' ? 'active-ai' : 'inactive'}">AI</button>
                    <button onclick="setStatus('${s.id}', 'AJ')" class="btn-status ${todayRecord.status === 'AJ' ? 'active-aj' : 'inactive'}">AJ</button>
                    <button onclick="setStatus('${s.id}', 'T')" class="btn-status ${todayRecord.status === 'T' ? 'active-t' : 'inactive'}">T</button>
                </div>
            </td>
            <td class="p-5 text-center">
                <input type="number" value="${todayRecord.lessons}" 
                       class="input-lesson-small" 
                       onchange="updateLec('${s.id}', this.value)">
            </td>
            <td class="p-5 text-center font-bold text-red-400 bg-slate-50/30">${stats.ai}</td>
            <td class="p-5 text-center font-bold text-blue-400 bg-slate-50/30">${stats.aj}</td>
            <td class="p-5 text-center font-bold text-amber-500 bg-slate-50/30">${stats.t}</td>
            <td class="p-5 text-right pr-10 font-black text-blue-500 text-base">${grade}%</td>
        </tr>`;
            }).join('');
            lucide.createIcons();
        }

        // Guardar el estado (P, AI, AJ, T)
        function setStatus(studentId, newStatus) {
            const date = document.getElementById('att-date').value;
            const dayLec = parseInt(document.getElementById('day-lessons').value) || 0;

            if (!state.attendance) state.attendance = {};
            if (!state.attendance[period]) state.attendance[period] = {};
            if (!state.attendance[period][date]) state.attendance[period][date] = {};

            let lessons = dayLec;

            // Si es tardía, por defecto es 1, pero validamos que no supere el día
            if (newStatus === 'T') {
                lessons = dayLec >= 1 ? 1 : 0;
            } else if (newStatus === 'P') {
                lessons = dayLec;
            }

            state.attendance[period][date][studentId] = { status: newStatus, lessons: lessons };
            save();
        }

        // Actualizar lecciones manuales
        function updateLec(studentId, value) {
            const date = document.getElementById('att-date').value;
            const dayLec = parseInt(document.getElementById('day-lessons').value) || 0;
            let newValue = parseInt(value);

            // Validación de seguridad: no puede ser mayor que las lecciones del día
            if (newValue > dayLec) {
                alert(`No se pueden asignar ${newValue} lecciones porque el máximo para hoy es ${dayLec}.`);
                newValue = dayLec;
            }

            if (state.attendance?.[period]?.[date]?.[studentId]) {
                state.attendance[period][date][studentId].lessons = newValue;
                save();
            }
        }

        // Cálculo de sumatorias AI, AJ, T del periodo
        function calculateStats(studentId) {
            let ai = 0, aj = 0, t = 0;
            const periodData = state.attendance?.[period] || {};

            for (const date in periodData) {
                const record = periodData[date][studentId];
                if (record) {
                    if (record.status === 'AI') ai += record.lessons;
                    if (record.status === 'AJ') aj += record.lessons;
                    if (record.status === 'T') t += 1; // Se cuenta el evento de llegada tardía
                }
            }
            return { ai, aj, t };
        }

        // Sumatoria de lecciones dadas (Total del Periodo)
        // Sumatoria de lecciones dadas (Total del Periodo) - CORREGIDO
        function calculateTotalLessons() {
            let total = 0;
            const periodData = state.attendance?.[period] || {};

            // Solo sumamos lecciones de fechas que realmente existen y tienen datos
            for (const date in periodData) {
                const records = Object.values(periodData[date]);
                if (records.length > 0) {
                    // Buscamos el valor máximo de lecciones registrado en ese día
                    const dailyMax = Math.max(...records.map(r => r.lessons || 0), 0);
                    total += dailyMax;
                }
            }
            return total;
        }
        // Lógica de la tabla de porcentajes MEP
        function calculateGrade(ai, t, total) {
            if (total === 0) return 5;

            // REGLA MEP: Cada tardía equivale a media ausencia injustificada (0.5)
            const ausenciasEquivalentes = ai + (t * 0.5);

            // El porcentaje se calcula sobre la suma de AI + el peso de las tardías
            const porcentajeInjustificado = (ausenciasEquivalentes / total) * 100;

            // Rangos según la tabla que me pasaste
            if (porcentajeInjustificado < 10) return 5;
            if (porcentajeInjustificado < 20) return 4;
            if (porcentajeInjustificado < 30) return 3;
            if (porcentajeInjustificado < 40) return 2;
            if (porcentajeInjustificado < 50) return 1;
            return 0; // 50% o más de ausencias equivalentes
        }

        function getRecord(id, date) {
            return state.attendance?.[period]?.[date]?.[id];
        }

        function deleteDate() {
            const date = document.getElementById('att-date').value;
            if (confirm(`¿Eliminar los registros del día ${date}?`)) {
                delete state.attendance[period][date];
                save();
            }
        }

        function save() {
            localStorage.setItem('academicApp_2026_data', JSON.stringify(state));
            renderAttendance();
        }
        function updateAllLessons() {
            const date = document.getElementById('att-date').value;
            const dayLec = parseInt(document.getElementById('day-lessons').value) || 0;

            if (state.attendance?.[period]?.[date]) {
                const dailyRecords = state.attendance[period][date];
                for (const id in dailyRecords) {
                    // Si el registro previo es mayor al nuevo límite, lo bajamos
                    if (dailyRecords[id].lessons > dayLec) {
                        dailyRecords[id].lessons = dayLec;
                    }
                }
            }
            save();
        }
        function showHistory() {
            const modal = document.getElementById('modal-history');
            const table = document.getElementById('history-table');
            const students = (state.students[lvl] || []).filter(s => s.section === sec).sort((a, b) => a.name.localeCompare(b.name));

            // Actualizar info del periodo
            const displayPeriod = period === '1' ? 'I' : period === '2' ? 'II' : period;
            document.getElementById('history-period-info').innerText = `Periodo ${displayPeriod} | Componente: 5%`;

            // Obtenemos todas las fechas grabadas en este periodo y las ordenamos
            const periodData = state.attendance?.[period] || {};
            const dates = Object.keys(periodData).sort();

            if (dates.length === 0) {
                alert("Aún no hay fechas registradas en este periodo.");
                return;
            }

            const totalLecPeriodo = calculateTotalLessons();

            // Construir encabezado de la tabla histórica
            let headerHtml = `
        <thead class="bg-slate-50 text-[9px] font-black text-slate-400 uppercase tracking-widest">
            <tr>
                <th class="p-4 sticky-col bg-slate-50 text-emerald-600 uppercase">Estudiante</th>
                ${dates.map(d => `<th class="p-4 text-center border-l border-slate-100">${d.split('-').reverse().slice(0, 2).join('/')}</th>`).join('')}
                <th class="p-4 text-center bg-emerald-200 text-emerald-800 border-l border-emerald-300 font-black uppercase tracking-tighter shadow-sm">Nota (5%)</th>
            </tr>
        </thead>`;

            // Construir filas de estudiantes
            let bodyHtml = `<tbody>${students.map(s => {
                const stats = calculateStats(s.id);
                const grade = calculateGrade(stats.ai, stats.t, totalLecPeriodo);

                return `
            <tr class="border-t border-slate-50 text-[11px]">
                <td class="p-4 font-bold text-slate-700 sticky-col bg-white whitespace-nowrap">${s.name}</td>
                ${dates.map(d => {
                    const rec = periodData[d][s.id] || { status: 'P', lessons: 0 };
                    let color = 'text-slate-300';
                    if (rec.status === 'AI') color = 'text-red-500 font-bold';
                    if (rec.status === 'AJ') color = 'text-blue-400 font-bold';
                    if (rec.status === 'T') color = 'text-amber-500 font-bold';

                    return `<td class="p-4 text-center border-l border-slate-50 ${color}">${rec.status}${rec.status !== 'P' ? '(' + rec.lessons + ')' : ''}</td>`;
                }).join('')}
                <td class="p-4 text-center font-black text-emerald-600 bg-emerald-50/30 border-l border-emerald-100">${grade}%</td>
            </tr>`;
            }).join('')}</tbody>`;

            table.innerHTML = headerHtml + bodyHtml;
            modal.classList.remove('hidden');
            lucide.createIcons();
        }

        function closeHistory() {
            document.getElementById('modal-history').classList.add('hidden');
        }
        function downloadPDF() {
            const students = (state.students[lvl] || []).filter(s => s.section === sec).sort((a, b) => a.name.localeCompare(b.name));
            const periodData = state.attendance?.[period] || {};
            const dates = Object.keys(periodData).sort();
            const totalLecPeriodo = calculateTotalLessons();

            if (dates.length === 0) return alert("No hay datos históricos para imprimir.");

            // Crear contenido para la ventana de impresión
            const printWindow = window.open('', '_blank');

            let html = `
    <html>
    <head>
        <title>Histórico de Asistencia - ${lvl}-${sec}</title>
        <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;800&display=swap" rel="stylesheet">
        <style>
            body { font-family: 'Outfit', sans-serif; padding: 40px; color: #334155; font-size: 10px; }
            .professional-header { display: flex; justify-content: space-between; border-bottom: 2px solid #f1f5f9; padding-bottom: 20px; margin-bottom: 30px; text-transform: uppercase; }
            .prof-data p { margin: 2px 0; font-size: 9px; color: #64748b; }
            .prof-data b { color: #334155; }
            
            h1 { font-size: 20px; margin: 0; color: #1e293b; font-weight: 800; }
            table { width: 100%; border-collapse: collapse; margin-top: 20px; table-layout: fixed; }
            th, td { border: 1px solid #cbd5e1; padding: 6px; text-align: center; word-wrap: break-word; font-size: 9px; }
            th { background: #f8fafc; font-size: 8px; font-weight: 800; text-transform: uppercase; }
            
            .name-cell { text-align: left !important; font-weight: 700; width: 25%; font-size: 9px; }
            .final-note { background: #ecfdf5; font-weight: 800; color: #059669; }
            .footer { margin-top: 50px; display: flex; justify-content: center; font-size: 9px; }
        </style>
    </head>
    <body>
        <div class="professional-header">
            <div>
                <h1>Histórico de Asistencia</h1>
                <p style="margin:5px 0 0 0; color:#10b981; font-weight:900; text-transform:uppercase; font-size:12px;">NIVEL: ${lvl} | SECCIÓN: ${sec} | PERIODO: ${period === '1' ? 'I' : period === '2' ? 'II' : period}</p>
            </div>
            <div class="prof-data">
                <p>INSTITUCIÓN: <b>${state.admin.institution || 'MEP'}</b></p>
                <p>MATERIA: <b>${state.admin.subject || 'MATEMÁTICAS'}</b></p>
                <p>DOCENTE: <b>${state.admin.name || '---'}</b></p>
                <p>RUBRO: <b>ASISTENCIA</b></p>
            </div>
        </div>

        <table>
            <thead>
                <tr>
                    <th style="width:200px">Estudiante</th>
                    ${dates.map(d => `<th>${d.split('-').reverse().slice(0, 2).join('/')}</th>`).join('')}
                    <th style="width:60px">Nota (5%)</th>
                </tr>
            </thead>
            <tbody>
                ${students.map(s => {
                const stats = calculateStats(s.id);
                const grade = calculateGrade(stats.ai, stats.t, totalLecPeriodo);
                return `
                        <tr>
                            <td class="name-cell">${s.name}</td>
                            ${dates.map(d => {
                    const rec = (state.attendance?.[period]?.[d]?.[s.id]) || { status: 'P' };
                    let color = '#64748b';
                    if (rec.status === 'AI') color = '#ef4444';
                    if (rec.status === 'AJ') color = '#0ea5e9';
                    if (rec.status === 'T') color = '#fbbf24';
                    return `<td style="color:${color}; font-weight:bold;">${rec.status}</td>`;
                }).join('')}
                            <td class="final-note">${grade}%</td>
                        </tr>`;
            }).join('')}
            </tbody>
        </table>

        <div class="footer">
            <div style="border-top:1px solid #334155; width:200px; padding-top:5px; text-align:center;">Firma del Docente</div>
        </div>
    </body>
    </html>`;

            printWindow.document.write(html);
            printWindow.document.close();

            // Esperar a que carguen las fuentes antes de imprimir
            printWindow.onload = function () {
                printWindow.print();
                printWindow.close();
            };
        }
        function toggleSidebar() {
            document.body.classList.toggle('sidebar-expanded');
        }
        document.addEventListener('DOMContentLoaded', init);
    </script>
    <div id="modal-history"
        class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-6xl max-h-[90vh] rounded-[2.5rem] shadow-2xl overflow-hidden flex flex-col">
            <div class="p-8 border-b border-slate-50 flex justify-between items-center">
                <div>
                    <h2 class="text-xl font-extrabold text-slate-800 uppercase tracking-tighter">
                        <i data-lucide="clock" class="w-6 h-6 icon-vibrant inline-block mr-2 mb-1"></i> Histórico de
                        Asistencia
                    </h2>
                    <p id="history-period-info"
                        class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mt-1">Periodo ---</p>
                </div>
                <button onclick="closeHistory()"
                    class="p-2 hover:bg-slate-50 rounded-xl text-slate-400 transition-all"><i
                        data-lucide="x"></i></button>
            </div>

            <div class="flex-1 overflow-auto p-8">
                <div class="table-container border border-slate-100 rounded-2xl overflow-hidden">
                    <table class="w-full text-left border-collapse" id="history-table">
                    </table>
                </div>
            </div>
        </div>
    </div>
</body>

</html>